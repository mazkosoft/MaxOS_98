<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>经典 Mac OS 桌面模拟</title>
    <!-- Tailwind CSS CDN (for basic layout helpers) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Classic Mac OS font and base styles */
        body {
            font-family: 'Geneva', 'Lucida Grande', 'Arial', sans-serif; /* Attempt to simulate Mac font */
            overflow: hidden; /* Prevent scrolling */
            cursor: default;
            user-select: none; /* Prevent text selection during drag */
            /* Default background, now always Mac OS 9 grey */
            background-color: #C0C0C0;
        }

        /* Desktop Background - Now always Mac OS 9 grey by default */
        .macos-desktop-bg {
            background-image: none; /* No default image */
            background-color: #C0C0C0; /* Default Mac OS 9 desktop grey */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: -2;
        }

        /* Top Menubar */
        .macos-menubar {
            background-color: #C2C2C2; /* Mac OS 9 chrome grey */
            border-bottom: 1px solid #404040; /* Darker bottom border */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 22px;
            display: flex;
            align-items: center;
            padding: 0 4px;
            font-size: 13px;
            z-index: 100;
            box-shadow: inset 0 1px 0 #F8F8F8; /* Top highlight */
        }
        .macos-menubar-item {
            padding: 2px 8px;
            cursor: pointer;
            color: #000000;
            white-space: nowrap;
            position: relative; /* For dropdown menus */
        }
        .macos-menubar-item:hover {
            background-color: #000080; /* Standard blue hover */
            color: #FFFFFF;
        }
        .macos-menubar-item .icon-container {
            height: 16px;
            width: 16px;
            vertical-align: middle;
            margin-right: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .macos-menubar-item .icon-container svg {
            width: 100%;
            height: 100%;
            fill: #000000; /* Default black fill */
            stroke: #000000;
            stroke-width: 0.5;
        }
        .macos-menubar-item:hover .icon-container svg {
            fill: #FFFFFF; /* White fill on hover */
            stroke: #FFFFFF;
        }
        /* Preserve color for specific icons (e.g., Apple logo) */
        .macos-menubar-item .icon-container svg.preserve-color {
            fill: currentColor;
            stroke: currentColor;
        }
        .macos-menubar-item:hover .icon-container svg.preserve-color {
            fill: currentColor;
            stroke: currentColor;
        }

        .macos-menubar-system-tray {
            margin-left: auto;
            display: flex;
            align-items: center;
            height: 100%;
            gap: 6px;
        }
        .macos-menubar-system-tray span {
            padding: 0 6px;
            color: #000000;
        }
        .macos-menubar-system-tray .icon-container {
            height: 16px;
            width: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .macos-menubar-system-tray .icon-container svg {
            width: 100%;
            height: 100%;
            fill: #555555; /* Darker icons in system tray */
            stroke: #555555;
        }

        /* Desktop Icons */
        .macos-desktop-icon {
            position: absolute; /* All desktop icons are now absolutely positioned */
            width: 70px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 4px;
            cursor: pointer;
            color: #000000;
            text-shadow: 1px 1px #FFFFFF;
            font-size: 13px;
            line-height: 1.2;
            text-align: center;
            transition: background-color 0.1s ease-in-out;
            z-index: 10;
        }
        .macos-desktop-icon .icon-container {
            width: 48px;
            height: 48px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .macos-desktop-icon .icon-container svg {
            width: 100%;
            height: 100%;
        }
        /* Selected state uses system blue background with white text */
        .macos-desktop-icon:hover, .macos-desktop-icon.selected {
            background-color: #000080; /* System blue */
            color: #FFFFFF;
            text-shadow: none; /* No shadow on white text */
        }
        .macos-desktop-icon.dragging {
            opacity: 0.7;
            cursor: grabbing;
        }
        /* No #desktop-icons-container as it's no longer a grid container */


        /* Window Common Styles */
        .macos-window {
            background-color: #C2C2C2; /* Main grey for window chrome */
            /* Outer border with strong 3D effect */
            border-top: 2px solid #F0F0F0;
            border-left: 2px solid #F0F0F0;
            border-right: 2px solid #808080;
            border-bottom: 2px solid #808080;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.5), inset 1px 1px 0 #FFFFFF, inset -1px -1px 0 #606060; /* Stronger outer shadow, subtle inner highlight */
            position: absolute;
            min-width: 200px;
            min-height: 150px;
            z-index: 50;
            resize: both;
            overflow: hidden;
            top: 50px;
            left: 150px;
            border-radius: 2px;
            display: flex; /* Use flexbox for vertical layout of titlebar, content, statusbar */
            flex-direction: column;
        }

        /* Window Titlebar - Mac OS 9 style */
        .macos-window-titlebar {
            background-color: #C2C2C2; /* Same as window chrome */
            color: #000000;
            padding: 1px 4px; /* Reduced padding for more compact titlebar */
            font-weight: bold;
            font-size: 13px;
            display: flex;
            align-items: center;
            height: 20px;
            cursor: grab;
            user-select: none;
            border-top: 1px solid #F8F8F8; /* Light top highlight */
            border-left: 1px solid #F8F8F8; /* Light left highlight */
            border-right: 1px solid #707070; /* Dark right shadow */
            border-bottom: 1px solid #707070; /* Dark bottom shadow */
            box-shadow: inset 1px 1px 0 #DDDDDD; /* Inner highlight for 3D effect */
            border-top-left-radius: 1px;
            border-top-right-radius: 1px;
            /* Pinstripe pattern for active titlebar */
            background-image: linear-gradient(to right, #C2C2C2 0%, #C2C2C2 9px, #A0A0A0 9px, #A0A0A0 10px);
            background-size: 10px 100%;
            flex-shrink: 0; /* Don't shrink titlebar */
        }
        .macos-window-titlebar.inactive {
            background-color: #D2D2D2; /* Slightly lighter for inactive */
            color: #808080; /* Grey text for inactive */
            box-shadow: none;
            border-top: 1px solid #E0E0E0;
            border-left: 1px solid #E0E0E0;
            border-right: 1px solid #A0A0A0;
            border-bottom: 1px solid #A0A0A0;
            background-image: none; /* No pinstripe for inactive */
        }
        .macos-window-titlebar.dragging {
            cursor: grabbing;
        }
        .macos-window-titlebar .window-title-text {
            flex-grow: 1; /* Allows title to take available space */
            text-align: center;
            margin: 0 4px; /* Adjust margins as controls are now on right */
        }
        /* Window Logo Area (Top-left) */
        .macos-window-titlebar .window-logo-area {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px; /* Square for logo area */
            height: 18px;
            margin-left: 2px; /* Small margin from left edge */
            margin-right: 4px; /* Space between logo and title */
            background-color: #C2C2C2;
            border-top: 1px solid #F8F8F8;
            border-left: 1px solid #F8F8F8;
            border-right: 1px solid #707070;
            border-bottom: 1px solid #707070;
            box-shadow: inset 1px 1px 0 #DDDDDD; /* Inner highlight */
        }
        .macos-window-titlebar .window-logo-area .icon-container {
            width: 14px; /* Inner icon size */
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .macos-window-titlebar .window-logo-area .icon-container svg {
            width: 100%;
            height: 100%;
        }

        /* Window Control Buttons (Top-right) */
        .macos-window-controls {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-right: 2px; /* Small margin from right edge */
        }
        .macos-window-controls button {
            width: 13px;
            height: 13px;
            border: 1px solid #707070; /* Darker border */
            background-color: #C2C2C2; /* Same as window chrome */
            box-shadow: inset 1px 1px 0 #F8F8F8, inset -1px -1px 0 #000000; /* Stronger 3D inset */
            cursor: pointer;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #000000;
            line-height: 1;
            padding: 0;
            border-radius: 0;
        }
        /* Close button specific styling for the 'x' mark */
        .macos-window-controls .close-btn::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background-color: #000000;
            clip-path: polygon(20% 0%, 0% 20%, 30% 50%, 0% 80%, 20% 100%, 50% 70%, 80% 100%, 100% 20%, 80% 0%, 50% 30%);
        }
        .macos-window-controls .minimize-btn::before {
            content: '';
            display: block;
            width: 8px;
            height: 2px;
            background-color: #000000;
            margin-top: 4px; /* Position it at the bottom */
        }
        .macos-window-controls .maximize-btn::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            border: 1px solid #000000; /* Square border */
            box-sizing: border-box;
        }

        .macos-window-controls button:active {
            border-top: 1px solid #000000;
            border-left: 1px solid #000000;
            border-bottom: 1px solid #F8F8F8;
            border-right: 1px solid #F8F8F8;
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #F8F8F8; /* Inverted 3D inset */
            transform: translateY(1.5px) translateX(1.5px); /* Increased shift for subtle click */
        }
        .macos-window-controls button:hover {
            background-color: #D2D2D2; /* Slightly lighter on hover */
        }
        /* Active window control buttons get a filled look */
        .macos-window-titlebar:not(.inactive) .macos-window-controls .close-btn {
            background-color: #000000; /* Black background when active */
            box-shadow: inset 1px 1px 0 #404040, inset -1px -1px 0 #808080; /* Darker inset for active */
        }
        .macos-window-titlebar:not(.inactive) .macos-window-controls .close-btn::before {
            background-color: #FFFFFF; /* White 'x' on black background */
        }
        .macos-window-titlebar:not(.inactive) .macos-window-controls .minimize-btn,
        .macos-window-titlebar:not(.inactive) .macos-window-controls .maximize-btn {
            background-color: #000000; /* Black background when active */
             box-shadow: inset 1px 1px 0 #404040, inset -1px -1px 0 #808080;
        }
        .macos-window-titlebar:not(.inactive) .macos-window-controls .minimize-btn::before,
        .macos-window-titlebar:not(.inactive) .macos-window-controls .maximize-btn::before {
            background-color: #FFFFFF; /* White symbols when active */
            border-color: #FFFFFF;
        }

        /* Inner menu bar (e.g., Finder) */
        .macos-inner-menu {
            background-color: #C2C2C2;
            border-bottom: 1px solid #707070;
            display: flex;
            font-size: 12px;
            height: 20px;
            align-items: center;
            padding: 0 4px;
            color: #000000;
            box-shadow: inset 0 1px 0 #F8F8F8;
            flex-shrink: 0; /* Don't shrink inner menu */
        }
        .macos-inner-menu-item {
            padding: 2px 6px;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }
        .macos-inner-menu-item:hover {
            background-color: #000080;
            color: #FFFFFF;
        }
        .macos-inner-menu-item.disabled {
            color: #A0A0A0;
            cursor: default;
        }
        .macos-inner-menu-item.disabled:hover {
            background-color: transparent;
            color: #A0A0A0;
        }

        /* Window Content Area */
        .macos-window-content {
            background-color: #C2C2C2; /* Same as chrome */
            font-size: 13px;
            flex-grow: 1; /* Allows content area to take remaining vertical space */
            box-sizing: border-box;
            color: #000000;
            padding: 1px;
            display: flex; /* Use flexbox for content and scrollbar layout */
            flex-direction: row;
            overflow: hidden; /* Prevent content overflow from affecting window resize */
        }
        .macos-content-inset { /* Inset content area (the distinct color from screenshot) */
            background-color: #E0E0E0; /* Light grey/blueish from screenshot */
            border: 1px solid #707070; /* Darker border for inset */
            box-shadow: inset 1px 1px 0 #FFFFFF; /* Lighter inner highlight */
            flex-grow: 1; /* Takes all available space horizontally */
            overflow-y: auto; /* Content inside this will scroll */
            padding: 8px;
            box-sizing: border-box;
            min-height: 50px; /* Ensure content inset has a minimum height */
        }

        /* Vertical Scrollbar (new element) */
        .macos-vertical-scrollbar {
            width: 16px; /* Width of the scrollbar */
            height: 100%;
            background-color: #C2C2C2;
            border-left: 1px solid #707070; /* Darker left border */
            box-shadow: inset 1px 0 0 #F8F8F8; /* Light highlight on left */
            flex-shrink: 0; /* Don't shrink */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1px; /* Padding inside for track/knob */
            box-sizing: border-box;
        }
        .macos-vertical-scrollbar .scroll-arrow {
            width: 14px;
            height: 14px;
            background-color: #C2C2C2;
            border-top: 1px solid #F8F8F8;
            border-left: 1px solid #F8F8F8;
            border-bottom: 1px solid #707070;
            border-right: 1px solid #707070;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-bottom: 1px;
        }
        .macos-vertical-scrollbar .scroll-arrow:active {
            border-top: 1px solid #707070;
            border-left: 1px solid #707070;
            border-bottom: 1px solid #F8F8F8;
            border-right: 1px solid #F8F8F8;
            transform: translateY(1.5px) translateX(1.5px);
        }
        .macos-vertical-scrollbar .scroll-arrow.up::before { content: '▲'; font-size: 8px; color: #000; }
        .macos-vertical-scrollbar .scroll-arrow.down::before { content: '▼'; font-size: 8px; color: #000; }

        .macos-vertical-scrollbar .scroll-track {
            flex-grow: 1; /* Takes remaining space between arrows */
            width: 14px;
            background-color: #C2C2C2;
            border: 1px solid #707070;
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #F8F8F8;
            position: relative;
            margin-bottom: 1px;
        }
        .macos-vertical-scrollbar .scroll-knob {
            position: absolute;
            width: 12px; /* Slightly smaller than track */
            height: 30px; /* Example height, will be dynamic */
            background-color: #C2C2C2;
            border-top: 1px solid #F8F8F8;
            border-left: 1px solid #F8F8F8;
            border-bottom: 1px solid #707070;
            border-right: 1px solid #707070;
            cursor: grab;
            left: 1px; /* Center within track */
        }
        .macos-vertical-scrollbar .scroll-knob.dragging {
            cursor: grabbing;
        }
        .macos-vertical-scrollbar .scroll-knob:active {
            border-top: 1px solid #707070;
            border-left: 1px solid #707070;
            border-bottom: 1px solid #F8F8F8;
            border-right: 1px solid #F8F8F8;
        }

        /* Top Menubar Dropdown Menus */
        .macos-menubar-sub-menu {
            position: absolute;
            top: 100%;
            left: 0;
            flex-direction: column;
            align-items: flex-start;
            min-width: 150px;
            padding: 4px 0;
            border: 1px solid #808080;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            display: none;
            z-index: 105;
            height: auto;
            background-color: #C2C2C2;
            border-top: 1px solid #F0F0F0;
            border-left: 1px solid #F0F0F0;
            border-right: 1px solid #808080;
            border-bottom: 1px solid #808080;
        }
        .macos-menubar-item:hover > .macos-menubar-sub-menu {
            display: flex;
        }
        .macos-menubar-sub-menu-separator {
            height: 1px;
            background-color: #808080;
            border-top: 1px solid #FFFFFF;
            margin: 4px 0;
            width: 100%;
        }

        /* Status Bar */
        .macos-status-bar {
            background-color: #C2C2C2;
            border-top: 1px solid #707070;
            height: 20px;
            display: flex;
            align-items: center;
            padding: 0 4px;
            font-size: 12px;
            color: #000000;
            box-shadow: inset 0 1px 0 #F8F8F8; /* Top highlight for inset effect */
            position: relative; /* For decorative edge */
            overflow: hidden; /* Ensure decorative edge doesn't overflow */
            flex-shrink: 0; /* Don't shrink status bar */
        }
        .macos-status-bar span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Status Button (bottom-left) */
        .macos-status-bar .status-button {
            width: 12px;
            height: 12px;
            border-radius: 0; /* Square */
            background-color: #C2C2C2;
            border-top: 1px solid #F8F8F8;
            border-left: 1px solid #F8F8F8;
            border-bottom: 1px solid #707070;
            border-right: 1px solid #707070;
            box-shadow: inset 1px 1px 0 #DDDDDD; /* Inner highlight */
            margin-right: 6px;
            flex-shrink: 0;
        }
        /* Status Progress Bar */
        .macos-status-bar .status-progress-bar {
            flex-grow: 1; /* Takes available space */
            height: 12px;
            background-color: #C2C2C2;
            border: 1px solid #707070;
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #F8F8F8; /* Inset effect */
            margin-right: 8px;
            overflow: hidden; /* For the fill */
            position: relative;
        }
        .macos-status-bar .status-progress-bar .progress-fill {
            height: 100%;
            width: 50%; /* Example width, can be controlled by JS */
            background-color: #00A000; /* Green color */
            box-shadow: inset 1px 1px 0 #00FF00, inset -1px -1px 0 #006000;
            border-right: 1px solid #006000;
        }
        /* Version Text */
        .macos-status-bar .version-text {
            margin-left: 8px;
            margin-right: 8px;
            font-size: 11px;
            color: #000000;
            flex-shrink: 0;
        }
        /* Bottom-Right Decorative Edge */
        .macos-status-bar .bottom-right-decorative-edge {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px; /* Width of the corner */
            height: 12px; /* Height of the corner */
            background-color: #C2C2C2;
            border-top: 1px solid #707070;
            border-left: 1px solid #707070;
            box-shadow: inset 1px 1px 0 #F8F8F8; /* Inner highlight */
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
        }
        .macos-status-bar .bottom-right-decorative-edge::before {
            content: '';
            width: 4px; /* Inner vertical line */
            height: 100%;
            background-color: #707070;
            border-left: 1px solid #F8F8F8;
            box-shadow: inset -1px 0 0 #000000;
        }
        .macos-status-bar .bottom-right-decorative-edge::after {
            content: '';
            width: 100%;
            height: 4px; /* Inner horizontal line */
            background-color: #707070;
            border-top: 1px solid #F8F8F8;
            box-shadow: inset 0 -1px 0 #000000;
            position: absolute;
            bottom: 0;
            left: 0;
        }


        /* Mac OS 9 3D Buttons */
        .macos-dialog-button {
            background-color: #C2C2C2;
            border-top: 1px solid #F8F8F8;
            border-left: 1px solid #F8F8F8;
            border-bottom: 1px solid #707070;
            border-right: 1px solid #707070;
            padding: 4px 12px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
            color: #000000;
            text-align: center;
            min-width: 70px;
            box-shadow: 1px 1px 0 #000000; /* Darker shadow */
            border-radius: 3px;
        }
        .macos-dialog-button:active {
            border-top: 1px solid #707070;
            border-left: 1px solid #707070;
            border-bottom: 1px solid #F8F8F8;
            border-right: 1px solid #F8F8F8;
            transform: translateY(1.5px) translateX(1.5px); /* Increased subtle shift on press */
            box-shadow: none; /* Remove shadow on press */
        }
        .macos-dialog-button.default { /* Default button (blue border) */
            border: 2px solid #000080;
            padding: 3px 11px;
        }
        .macos-dialog-button.default:active {
            border: 2px solid #000000; /* Darker border on press for default button */
            transform: translateY(1.5px) translateX(1.5px);
        }

        /* Input Fields */
        .macos-input {
            background-color: #FFFFFF;
            border: 1px solid #707070;
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #DDDDDD; /* Stronger inset */
            padding: 2px 4px;
            font-size: 13px;
            color: #000000;
            outline: none;
        }

        /* Checkboxes/Radio Buttons/Toggles */
        .macos-checkbox-container, .macos-radio-container {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 13px;
            color: #000000;
        }
        .macos-checkbox-container input[type="checkbox"],
        .macos-radio-container input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border: 1px solid #707070;
            background-color: #C2C2C2;
            margin-right: 6px;
            cursor: pointer;
            position: relative;
            outline: none;
            box-shadow: inset 1px 1px 0 #F8F8F8, inset -1px -1px 0 #000000; /* Stronger 3D inset */
        }
        .macos-checkbox-container input[type="checkbox"] { border-radius: 2px; }
        .macos-radio-container input[type="radio"] { border-radius: 50%; }

        .macos-checkbox-container input[type="checkbox"]:checked::before {
            content: '✓';
            display: block;
            position: absolute;
            top: -1px;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 10px;
            color: #000000;
            text-align: center;
            line-height: 12px;
        }
        .macos-radio-container input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background-color: #000000; /* Black dot */
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* On/Off Toggle Button Group (Mac OS 9 style) */
        .macos-toggle-button-container {
            display: flex;
            border: 1px solid #707070;
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #F8F8F8; /* Stronger inset for container */
        }
        .macos-toggle-button {
            background-color: #C2C2C2;
            padding: 4px 10px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
            color: #000000;
            flex-grow: 1;
            text-align: center;
            border: none; /* Buttons inside container don't have separate borders */
        }
        .macos-toggle-button.active {
            background-color: #808080; /* Darker grey when active/pressed */
            color: #FFFFFF;
            /* Inverted borders for pressed state */
            border-top: 1px solid #707070; /* Darker border on active top/left */
            border-left: 1px solid #707070;
            border-bottom: 1px solid #F8F8F8; /* Lighter border on active bottom/right */
            border-right: 1px solid #F8F8F8;
            box-shadow: none; /* Remove shadow on pressed */
        }
        /* Borders between active/inactive toggle buttons */
        .macos-toggle-button:first-child.active + .macos-toggle-button:not(.active) {
            border-left: 1px solid #707070; /* Separator line between buttons */
            box-shadow: inset 1px 0 0 #000000;
        }
        .macos-toggle-button:not(.active) + .macos-toggle-button.active {
            border-left: 1px solid #F8F8F8; /* Separator line between buttons */
            box-shadow: inset -1px 0 0 #000000;
        }

        /* Finder/Explorer item (folders, drives etc.) */
        .macos-explorer-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 4px;
            cursor: pointer;
            color: #000000;
            font-size: 12px;
            text-align: center;
            height: 70px;
        }
        .macos-explorer-item .icon-container {
            width: 32px;
            height: 32px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .macos-explorer-item .icon-container svg {
            width: 100%;
            height: 100%;
        }
        .macos-explorer-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .macos-explorer-item:hover, .macos-explorer-item.selected {
            background-color: #000080; /* System blue */
            color: #FFFFFF;
        }
        
        /* Hello Window specific elements */
        .hello-window-icons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 5px;
            padding: 5px;
            flex-grow: 1;
            /* overflow-y: auto; -- Handled by custom scrollbar now */
        }
        .hello-window-bottom-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 5px;
            border-top: 1px solid #707070; /* Darker border */
            box-shadow: inset 0 1px 0 #F8F8F8; /* Top highlight */
            height: 25px;
            font-size: 11px;
            flex-shrink: 0; /* Don't shrink these controls */
        }
        .hello-window-bottom-square {
            width: 12px;
            height: 12px;
            background-color: #FFFFFF; /* Solid white from screenshot */
            border: 1px solid #707070; /* Darker border */
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #F8F8F8; /* Inset effect */
            flex-shrink: 0;
            margin-left: 4px;
            margin-right: 4px;
        }
        .hello-window-scroll-indicator {
            width: 100px;
            height: 12px;
            background-color: #C2C2C2; /* Grey background */
            border: 1px solid #707070;
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #F8F8F8; /* Inset effect */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2px;
            flex-shrink: 0;
            margin: 0 4px;
        }
        .hello-window-scroll-indicator-arrow {
            width: 10px;
            height: 10px;
            background-color: #C2C2C2;
            border-top: 1px solid #F8F8F8;
            border-left: 1px solid #F8F8F8;
            border-bottom: 1px solid #707070;
            border-right: 1px solid #707070;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #000000;
        }
        .hello-window-scroll-indicator-arrow:active {
             border-top: 1px solid #707070;
             border-left: 1px solid #707070;
             border-bottom: 1px solid #F8F8F8;
             border-right: 1px solid #F8F8F8;
             transform: translateY(1.5px) translateX(1.5px); /* Increased subtle shift */
        }
        .hello-window-scroll-indicator-track {
            flex-grow: 1;
            height: 4px;
            background-color: #808080; /* Darker grey track */
            border: 1px solid #000000; /* Black border */
            position: relative;
            margin: 0 2px;
        }
        .hello-window-scroll-indicator-thumb {
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 100%;
            background-color: #C2C2C2;
            border-top: 1px solid #F8F8F8;
            border-left: 1px solid #F8F8F8;
            border-bottom: 1px solid #707070;
            border-right: 1px solid #707070;
        }

        /* User/Application Menu (Apple Logo Menu) */
        .macos-application-menu {
            background-color: #C2C2C2;
            border: 1px solid #808080;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: absolute;
            top: 22px;
            left: 0;
            width: 200px;
            padding: 0;
            display: none;
            flex-direction: column;
            z-index: 101;
            border-top-right-radius: 4px;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            border-top: 1px solid #F0F0F0;
            border-left: 1px solid #F0F0F0;
            border-right: 1px solid #808080;
            border-bottom: 1px solid #808080;
        }
        .macos-application-menu.active {
            display: flex;
        }
        .macos-application-menu-user {
            background: linear-gradient(to right, #000080, #3030A0); /* Blue gradient from Mac OS 9 */
            color: #FFFFFF;
            padding: 6px 8px;
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid #000060; /* Darker blue border */
            border-top: 1px solid #6060D0; /* Lighter blue highlight */
            margin-bottom: 4px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
        }
        .macos-application-menu-user .icon-container {
            width: 32px;
            height: 32px;
            margin-right: 8px;
            border: 1px solid #FFFFFF;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .macos-application-menu-user .icon-container svg {
            width: 100%;
            height: 100%;
        }
        .macos-application-menu-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            font-size: 13px;
            cursor: pointer;
            color: #000000;
        }
        .macos-application-menu-item:hover {
            background-color: #000080;
            color: #FFFFFF;
        }
        .macos-application-menu-item .icon-container {
            width: 18px;
            height: 18px;
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .macos-application-menu-item .icon-container svg {
            width: 100%;
            height: 100%;
            fill: #000000; /* Default black fill */
            stroke: #000000;
        }
        .macos-application-menu-item:hover .icon-container svg {
            fill: #FFFFFF; /* White fill on hover */
            stroke: #FFFFFF;
        }
        .macos-application-menu-item .icon-container svg.preserve-color {
            fill: currentColor;
            stroke: currentColor;
        }
        .macos-application-menu-item:hover .icon-container svg.preserve-color {
            fill: currentColor;
            stroke: currentColor;
        }
        .macos-application-menu-separator {
            height: 1px;
            background-color: #808080;
            border-top: 1px solid #FFFFFF;
            margin: 4px 0;
        }

        /* Sub-menu styles (for Apple Application Menu) */
        .macos-sub-menu {
            background-color: #C2C2C2;
            border: 1px solid #808080;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: absolute;
            left: 100%;
            top: -1px;
            width: 180px;
            padding: 4px 0;
            display: none;
            flex-direction: column;
            z-index: 102;
            border-radius: 4px;
            border-top: 1px solid #F0F0F0;
            border-left: 1px solid #F0F0F0;
            border-right: 1px solid #808080;
            border-bottom: 1px solid #808080;
        }
        .macos-sub-menu.active {
            display: flex;
        }
        .macos-sub-menu-arrow {
            margin-left: auto;
            margin-right: 4px;
            color: #000000;
        }
        .macos-application-menu-item.has-submenu:hover > .macos-sub-menu {
            display: flex;
        }

        /* Loading indicator for LLM calls */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border-radius: 2px;
        }
        .loading-overlay .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal for Save/Open prompts */
        .macos-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .macos-modal-content {
            background-color: #C2C2C2;
            border: 1px solid #000000; /* Outer dark border */
            box-shadow: 3px 3px 6px rgba(0,0,0,0.5); /* Stronger window shadow */
            padding: 15px;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 300px;
            font-size: 13px;
            color: #000000;
            border-top: 1px solid #F0F0F0;
            border-left: 1px solid #F0F0F0;
            border-right: 1px solid #808080;
            border-bottom: 1px solid #808080;
        }
        .macos-modal-content input[type="text"] {
            padding: 2px 4px;
            border: 1px solid #707070; /* Darker border */
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #DDDDDD; /* Inset effect */
            background-color: #FFFFFF;
            outline: none;
            font-size: 13px;
            width: 100%;
        }
        .macos-modal-content input[type="file"] {
            font-size: 13px;
            color: #000000;
            border: 1px solid #707070; /* Darker border */
            box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #DDDDDD;
            background-color: #FFFFFF;
            padding: 2px 4px;
        }
        .macos-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">
    <!-- Desktop background layer -->
    <div class="macos-desktop-bg" id="desktop-bg"></div>

    <!-- Top Menubar -->
    <header class="macos-menubar">
        <div id="apple-logo-menu-item" class="macos-menubar-item">
            <div class="icon-container"></div>
        </div>
        <!-- Default App Title (e.g., Finder, or active app) -->
        <div id="active-app-title" class="macos-menubar-item font-bold">Finder</div> 
        
        <!-- Finder File Menu -->
        <div id="finder-file-menu-item" class="macos-menubar-item">文件
            <div class="macos-menubar-sub-menu">
                <div class="macos-menubar-sub-menu-item" data-action="new-folder">
                    <div class="icon-container"></div>
                    <span>新建文件夹</span>
                </div>
                <div class="macos-menubar-sub-menu-item" data-action="get-info">
                    <div class="icon-container"></div>
                    <span>显示信息</span>
                </div>
                <div class="macos-menubar-sub-menu-separator"></div>
                <div class="macos-menubar-sub-menu-item" data-action="change-wallpaper">
                    <div class="icon-container"></div>
                    <span>更改桌面背景...</span>
                </div>
                <div class="macos-menubar-sub-menu-separator"></div>
                <div class="macos-menubar-sub-menu-item" data-action="empty-trash">
                    <div class="icon-container"></div>
                    <span>清倒废纸篓</span>
                </div>
                <div class="macos-menubar-sub-menu-separator"></div>
                <div class="macos-menubar-sub-menu-item" data-action="close-active-window">
                    <div class="icon-container"></div>
                    <span>关闭窗口</span>
                </div>
            </div>
        </div>

        <div id="edit-menu-item" class="macos-menubar-item">编辑
            <div class="macos-menubar-sub-menu">
                <!-- Theme change functionality removed as per user request -->
            </div>
        </div>
        <div class="macos-menubar-item">视图</div>
        <div class="macos-menubar-item">工具</div>
        <div class="macos-menubar-item">窗口</div>
        <div class="macos-menubar-item">服务</div>
        <div class="macos-menubar-item">帮助</div>

        <div class="macos-menubar-system-tray">
            <span id="current-time"></span>
            <div class="icon-container"></div>
            <div class="icon-container"></div>
            <div class="icon-container"></div>
            <span>A</span>
            <div class="icon-container"></div>
        </div>
    </header>

    <!-- Desktop area (below menubar) -->
    <div id="desktop-area" class="flex-grow relative px-4 pt-4 pb-8" style="padding-top: 30px;">
        <!-- Desktop icons - now directly in desktop-area with absolute positioning -->
        <div id="databox-icon" class="macos-desktop-icon" style="top: 30px; left: 20px;">
            <div class="icon-container"></div>
            <span>DataBox</span>
        </div>
        <div id="trash-icon" class="macos-desktop-icon" style="top: 120px; left: 20px;">
            <div class="icon-container"></div>
            <span>Trash</span>
        </div>

        <!-- Window templates (hidden by default) -->
        <!-- "Hello!" Window (simulating Finder window) -->
        <div id="hello-window" class="macos-window" style="display: none; left: 100px; top: 80px; width: 400px; height: 300px;">
            <div class="macos-window-titlebar">
                <div class="window-logo-area">
                    <div class="icon-container window-icon-container"></div>
                </div>
                <span class="window-title-text">Hello!</span>
                <div class="macos-window-controls">
                    <button class="close-btn"></button>
                    <button class="minimize-btn"></button>
                    <button class="maximize-btn"></button>
                </div>
            </div>
            <div class="macos-inner-menu">
                <div class="macos-inner-menu-item">文件</div>
                <div class="macos-inner-menu-item">编辑</div>
                <div class="macos-inner-menu-item">视图</div>
            </div>
            <div class="macos-window-content"> <!-- Height is now controlled by flex-grow -->
                <div class="macos-content-inset" id="hello-window-content-inset" style="display: flex; flex-direction: column;">
                    <div style="font-size: 12px; margin-bottom: 8px; color: #000000;">
                        <span>mass:werk 7</span>
                    </div>
                    <div class="hello-window-icons-grid">
                        <div class="macos-explorer-item">
                            <div class="icon-container"></div>
                            <span>Folder 1</span>
                        </div>
                        <div class="macos-explorer-item">
                            <div class="icon-container"></div>
                            <span>Folder 2</span>
                        </div>
                        <div class="macos-explorer-item">
                            <div class="icon-container"></div>
                            <span>Document</span>
                        </div>
                        <div class="macos-explorer-item">
                            <div class="icon-container"></div>
                            <span>Package</span>
                        </div>
                        <div class="macos-explorer-item">
                            <div class="icon-container"></div>
                            <span>Disk</span>
                        </div>
                        <div class="macos-explorer-item">
                             <div class="icon-container"></div>
                             <span>Filled Circle</span>
                        </div>
                         <div class="macos-explorer-item">
                             <div class="icon-container"></div>
                             <span>Empty Circle</span>
                        </div>
                         <div class="macos-explorer-item">
                             <div class="icon-container"></div>
                             <span>Checkmark</span>
                        </div>
                        <!-- Add more items to make it scrollable -->
                        <div class="macos-explorer-item"><div class="icon-container"></div><span>Item A</span></div>
                        <div class="macos-explorer-item"><div class="icon-container"></div><span>Item B</span></div>
                        <div class="macos-explorer-item"><div class="icon-container"></div><span>Item C</span></div>
                        <div class="macos-explorer-item"><div class="icon-container"></div><span>Item D</span></div>
                        <div class="macos-explorer-item"><div class="icon-container"></div><span>Item E</span></div>
                        <div class="macos-explorer-item"><div class="icon-container"></div><span>Item F</span></div>
                        <div class="macos-explorer-item"><div class="icon-container"></div><span>Item G</span></div>
                        <div class="macos-explorer-item"><div class="icon-container"></div><span>Item H</span></div>
                    </div>
                    <div class="hello-window-bottom-controls">
                        <div class="hello-window-bottom-square"></div>
                        <div class="hello-window-scroll-indicator">
                            <div class="hello-window-scroll-indicator-arrow">&lt;</div>
                            <div class="hello-window-scroll-indicator-track">
                                <div class="hello-window-scroll-indicator-thumb" style="width: 20px;"></div>
                            </div>
                            <div class="hello-window-scroll-indicator-arrow">&gt;</div>
                        </div>
                        <div class="hello-window-scroll-indicator" style="width: 50px;">
                             <div class="hello-window-scroll-indicator-thumb" style="width: 30px;"></div>
                        </div>
                    </div>
                </div>
                <!-- Vertical Scrollbar for Hello Window -->
                <div class="macos-vertical-scrollbar" id="hello-vertical-scrollbar">
                    <div class="scroll-arrow up"></div>
                    <div class="scroll-track">
                        <div class="scroll-knob" id="hello-scroll-knob"></div>
                    </div>
                    <div class="scroll-arrow down"></div>
                </div>
            </div>
            <div class="macos-status-bar">
                <div class="status-button"></div>
                <div class="status-progress-bar">
                    <div class="progress-fill" style="width: 75%;"></div>
                </div>
                <span class="version-text">Hello! 窗口就绪</span>
                <div class="bottom-right-decorative-edge"></div>
            </div>
        </div>

        <!-- "DataBox" Window (simulating a drive) -->
        <div id="databox-window" class="macos-window" style="display: none; left: 150px; top: 120px; width: 400px; height: 300px;">
            <div class="macos-window-titlebar">
                <div class="window-logo-area">
                    <div class="icon-container window-icon-container"></div>
                </div>
                <span class="window-title-text">DataBox</span>
                <div class="macos-window-controls">
                    <button class="close-btn"></button>
                    <button class="minimize-btn"></button>
                    <button class="maximize-btn"></button>
                </div>
            </div>
            <div class="macos-inner-menu">
                <div class="macos-inner-menu-item">文件</div>
                <div class="macos-inner-menu-item">编辑</div>
                <div class="macos-inner-menu-item">视图</div>
            </div>
            <div class="macos-window-content">
                <div class="macos-content-inset" id="databox-window-content-inset" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 15px;">
                    <div class="macos-explorer-item">
                        <div class="icon-container"></div>
                        <span>Macintosh HD</span>
                    </div>
                    <div class="macos-explorer-item">
                        <div class="icon-container"></div>
                        <span>CD-ROM</span>
                    </div>
                    <div class="macos-explorer-item">
                        <div class="icon-container"></div>
                        <span>Floppy Disk</span>
                    </div>
                    <!-- Add more items to make it scrollable -->
                    <div class="macos-explorer-item"><div class="icon-container"></div><span>Drive A</span></div>
                    <div class="macos-explorer-item"><div class="icon-container"></div><span>Drive B</span></div>
                    <div class="macos-explorer-item"><div class="icon-container"></div><span>Drive C</span></div>
                    <div class="macos-explorer-item"><div class="icon-container"></div><span>Drive D</span></div>
                </div>
                <!-- Vertical Scrollbar for DataBox Window -->
                <div class="macos-vertical-scrollbar" id="databox-vertical-scrollbar">
                    <div class="scroll-arrow up"></div>
                    <div class="scroll-track">
                        <div class="scroll-knob" id="databox-scroll-knob"></div>
                    </div>
                    <div class="scroll-arrow down"></div>
                </div>
            </div>
            <div class="macos-status-bar">
                <div class="status-button"></div>
                <div class="status-progress-bar">
                    <div class="progress-fill" style="width: 30%;"></div>
                </div>
                <span class="version-text">3 个项目，1.2 GB 可用</span>
                <div class="bottom-right-decorative-edge"></div>
            </div>
        </div>

        <!-- "Trash" Window (simulating recycle bin) -->
        <div id="trash-window" class="macos-window" style="display: none; left: 200px; top: 180px; width: 350px; height: 250px;">
            <div class="macos-window-titlebar">
                <div class="window-logo-area">
                    <div class="icon-container window-icon-container"></div>
                </div>
                <span class="window-title-text">Trash</span>
                <div class="macos-window-controls">
                    <button class="close-btn"></button>
                    <button class="minimize-btn"></button>
                    <button class="maximize-btn"></button>
                </div>
            </div>
            <div class="macos-inner-menu">
                <div class="macos-inner-menu-item">文件</div>
                <div class="macos-inner-menu-item">操作</div>
            </div>
            <div class="macos-window-content">
                <div class="macos-content-inset" id="trash-window-content-inset" style="text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div class="icon-container" style="width:64px; height:64px; margin-bottom: 10px;"></div>
                    <p style="font-size: 13px; color: #000000;">回收站是空的。</p>
                    <p style="font-size: 12px; color: #808080; margin-top: 5px;">请将不需要的文件拖到这里。</p>
                </div>
                <!-- Vertical Scrollbar for Trash Window -->
                <div class="macos-vertical-scrollbar" id="trash-vertical-scrollbar">
                    <div class="scroll-arrow up"></div>
                    <div class="scroll-track">
                        <div class="scroll-knob" id="trash-scroll-knob"></div>
                    </div>
                    <div class="scroll-arrow down"></div>
                </div>
            </div>
            <div class="macos-status-bar">
                <div class="status-button"></div>
                <div class="status-progress-bar">
                    <div class="progress-fill" style="width: 0%;"></div>
                </div>
                <span class="version-text">0 个项目</span>
                <div class="bottom-right-decorative-edge"></div>
            </div>
        </div>

        <!-- "TextEdit" Window (simulating text editor) -->
        <div id="textedit-window" class="macos-window" style="display: none; left: 250px; top: 100px; width: 500px; height: 400px;">
            <div class="macos-window-titlebar">
                <div class="window-logo-area">
                    <div class="icon-container window-icon-container"></div>
                </div>
                <span class="window-title-text" id="textedit-window-title">无标题</span>
                <div class="macos-window-controls">
                    <button class="close-btn"></button>
                    <button class="minimize-btn"></button>
                    <button class="maximize-btn"></button>
                </div>
            </div>
            <div class="macos-inner-menu">
                <div class="macos-inner-menu-item" id="textedit-file-menu">文件<span class="macos-sub-menu-arrow" style="margin-left: 8px;"></span>
                    <div class="macos-sub-menu" style="left: 0; top: 20px; width: 120px;">
                        <div class="macos-application-menu-item" data-action="textedit-new-doc"><span>新建</span></div>
                        <div class="macos-application-menu-item" data-action="textedit-open-doc"><span>打开...</span></div>
                        <div class="macos-application-menu-item" data-action="textedit-save-doc"><span>保存</span></div>
                        <div class="macos-application-menu-item" data-action="textedit-save-as-doc"><span>另存为...</span></div>
                    </div>
                </div>
                <div class="macos-inner-menu-item">编辑</div>
                <div class="macos-inner-menu-item">格式</div>
            </div>
            <div class="macos-window-content">
                <div class="macos-content-inset" id="textedit-window-content-inset" style="padding: 0; border: none; box-shadow: none; display: flex; flex-direction: column;">
                    <textarea id="textedit-textarea" class="macos-input" style="flex-grow: 1; width: 100%; height: 100%; resize: none; border: none; box-shadow: none; padding: 10px; font-family: 'Monaco', 'Courier New', monospace;"></textarea>
                    <div style="display: flex; justify-content: flex-end; gap: 8px; padding: 8px; background-color: #C2C2C2; border-top: 1px solid #707070; box-shadow: inset 0 1px 0 #F8F8F8;">
                        <button id="summarize-btn" class="macos-dialog-button">✨ 总结</button>
                        <button id="continue-btn" class="macos-dialog-button">✨ 继续写作</button>
                    </div>
                </div>
                <!-- Vertical Scrollbar for TextEdit Window -->
                <div class="macos-vertical-scrollbar" id="textedit-vertical-scrollbar">
                    <div class="scroll-arrow up"></div>
                    <div class="scroll-track">
                        <div class="scroll-knob" id="textedit-scroll-knob"></div>
                    </div>
                    <div class="scroll-arrow down"></div>
                </div>
            </div>
            <div class="macos-status-bar" id="textedit-status-bar-element">
                <div class="status-button"></div>
                <div class="status-progress-bar">
                    <div class="progress-fill" style="width: 60%;"></div>
                </div>
                <span class="version-text" id="textedit-status-text">行: 1, 列: 1 | 字数: 0, 字符数: 0</span>
                <div class="bottom-right-decorative-edge"></div>
            </div>
        </div>

        <!-- "Applications" Window (simulating application list) -->
        <div id="applications-window" class="macos-window" style="display: none; left: 300px; top: 150px; width: 450px; height: 350px;">
            <div class="macos-window-titlebar">
                <div class="window-logo-area">
                    <div class="icon-container window-icon-container"></div>
                </div>
                <span class="window-title-text">应用程序</span>
                <div class="macos-window-controls">
                    <button class="close-btn"></button>
                    <button class="minimize-btn"></button>
                    <button class="maximize-btn"></button>
                </div>
            </div>
            <div class="macos-inner-menu">
                <div class="macos-inner-menu-item">文件</div>
                <div class="macos-inner-menu-item">编辑</div>
                <div class="macos-inner-menu-item">视图</div>
            </div>
            <div class="macos-window-content">
                <div class="macos-content-inset" id="applications-window-content-inset" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; padding: 15px;">
                    <div class="macos-explorer-item" data-action="message" data-title="计算器" data-message="计算器应用程序。">
                        <div class="icon-container"></div>
                        <span>计算器</span>
                    </div>
                    <div class="macos-explorer-item" data-action="message" data-title="画图" data-message="画图应用程序。">
                        <div class="icon-container"></div>
                        <span>画图</span>
                    </div>
                    <div class="macos-explorer-item" data-action="message" data-title="游戏" data-message="游戏应用程序。">
                        <div class="icon-container"></div>
                        <span>游戏</span>
                    </div>
                    <div class="macos-explorer-item" data-action="message" data-title="浏览器" data-message="浏览器应用程序。">
                        <div class="icon-container"></div>
                        <span>浏览器</span>
                    </div>
                    <div class="macos-explorer-item" data-action="message" data-title="媒体播放器" data-message="媒体播放器应用程序。">
                        <div class="icon-container"></div>
                        <span>媒体播放器</span>
                    </div>
                    <div class="macos-explorer-item" data-action="message" data-title="邮件" data-message="邮件应用程序。">
                        <div class="icon-container"></div>
                        <span>邮件</span>
                    </div>
                    <!-- Add more items to make it scrollable -->
                    <div class="macos-explorer-item"><div class="icon-container"></div><span>App A</span></div>
                    <div class="macos-explorer-item"><div class="icon-container"></div><span>App B</span></div>
                    <div class="macos-explorer-item"><div class="icon-container"></div><span>App C</span></div>
                    <div class="macos-explorer-item"><div class="icon-container"></div><span>App D</span></div>
                </div>
                <!-- Vertical Scrollbar for Applications Window -->
                <div class="macos-vertical-scrollbar" id="applications-vertical-scrollbar">
                    <div class="scroll-arrow up"></div>
                    <div class="scroll-track">
                        <div class="scroll-knob" id="applications-scroll-knob"></div>
                    </div>
                    <div class="scroll-arrow down"></div>
                </div>
            </div>
            <div class="macos-status-bar">
                <div class="status-button"></div>
                <div class="status-progress-bar">
                    <div class="progress-fill" style="width: 80%;"></div>
                </div>
                <span class="version-text">10 个应用程序</span>
                <div class="bottom-right-decorative-edge"></div>
            </div>
        </div>

        <!-- On/Off Dialog (example) -->
        <div id="on-off-dialog" class="macos-window" style="display: none; left: 450px; top: 180px; width: 220px; height: 180px;">
            <div class="macos-window-titlebar">
                <div class="window-logo-area">
                    <div class="icon-container window-icon-container"></div>
                </div>
                <span class="window-title-text">设置</span>
                <div class="macos-window-controls">
                    <button class="close-btn"></button>
                    <!-- Minimize/Maximize usually not present on small dialogs -->
                </div>
            </div>
            <div class="macos-window-content">
                <div class="macos-content-inset" id="on-off-dialog-content-inset" style="border: none; background-color: transparent; box-shadow: none; min-height: auto; display: flex; flex-direction: column; height: 100%;">
                    <p class="mb-4" style="color: #000000;">请调整以下设置:</p>
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                        <div class="macos-toggle-button-container">
                            <button id="on-toggle-btn" class="macos-toggle-button active">On</button>
                            <button id="off-toggle-btn" class="macos-toggle-button">Off</button>
                        </div>
                    </div>
                    <div class="macos-radio-container">
                        <input type="radio" name="setting-radio-group" id="setting-radio1" checked>
                        <label for="setting-radio1">选项 A</label>
                    </div>
                    <div class="macos-radio-container">
                        <input type="radio" name="setting-radio-group" id="setting-radio2">
                        <label for="setting-radio2">选项 B</label>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: auto;">
                        <button class="macos-dialog-button default" id="on-off-ok-button">OK</button>
                    </div>
                </div>
                <!-- Vertical Scrollbar for On/Off Dialog (might not be needed for small dialogs, but included for consistency) -->
                <div class="macos-vertical-scrollbar" id="on-off-dialog-vertical-scrollbar">
                    <div class="scroll-arrow up"></div>
                    <div class="scroll-track">
                        <div class="scroll-knob" id="on-off-dialog-scroll-knob"></div>
                    </div>
                    <div class="scroll-arrow down"></div>
                </div>
            </div>
            <div class="macos-status-bar">
                <div class="status-button"></div>
                <div class="status-progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>
                <span class="version-text">设置就绪</span>
                <div class="bottom-right-decorative-edge"></div>
            </div>
        </div>

        <!-- Message Box template (reusable) -->
        <div id="message-box-template" class="message-box-overlay" style="display: none;">
            <div class="message-box macos-window" style="min-height: 120px;"> <!-- Added min-height for message box -->
                <div class="macos-window-titlebar">
                    <div class="window-logo-area">
                        <div class="icon-container window-icon-container"></div>
                    </div>
                    <span id="message-box-title">消息</span>
                    <div class="macos-window-controls">
                        <button class="close-btn"></button>
                    </div>
                </div>
                <div class="macos-window-content" style="flex-grow: 1;"> <!-- Adjusted for flexbox -->
                    <div class="macos-content-inset" id="message-box-content-inset" style="padding: 16px; display: flex; align-items: center; gap: 12px; box-shadow: none; border: none; min-height: unset;">
                        <div class="icon-container" id="message-box-icon-container" style="width:32px; height:32px;"></div>
                        <span id="message-box-text" class="message-box-text">这是一个消息。</span>
                    </div>
                    <!-- Vertical Scrollbar for Message Box (usually not needed, but included for structure) -->
                    <div class="macos-vertical-scrollbar" id="message-box-vertical-scrollbar">
                        <div class="scroll-arrow up"></div>
                        <div class="scroll-track">
                            <div class="scroll-knob" id="message-box-scroll-knob"></div>
                        </div>
                        <div class="scroll-arrow down"></div>
                    </div>
                </div>
                <div class="message-box-buttons" style="display: flex; justify-content: center; padding-bottom: 12px; flex-shrink: 0;">
                    <button class="macos-dialog-button default" id="message-box-ok-button">OK</button>
                </div>
                <div class="macos-status-bar"> <!-- Message box also needs a status bar -->
                    <div class="status-button"></div>
                    <div class="status-progress-bar">
                        <div class="progress-fill" style="width: 10%;"></div>
                    </div>
                    <span class="version-text">完成</span>
                    <div class="bottom-right-decorative-edge"></div>
                </div>
            </div>
        </div>

        <!-- File Save/Open Dialog template -->
        <div id="file-dialog-template" class="macos-modal" style="display: none;">
            <div class="macos-modal-content">
                <p id="file-dialog-message"></p>
                <input type="text" id="file-dialog-input" class="macos-input" placeholder="请输入文件名...">
                <div class="macos-modal-buttons">
                    <button class="macos-dialog-button" id="file-dialog-cancel">取消</button>
                    <button class="macos-dialog-button default" id="file-dialog-ok">确定</button>
                </div>
            </div>
        </div>

        <!-- Desktop Wallpaper Settings Window -->
        <div id="wallpaper-settings-window" class="macos-window" style="display: none; left: 300px; top: 100px; width: 450px; height: 400px;">
            <div class="macos-window-titlebar">
                <div class="window-logo-area">
                    <div class="icon-container window-icon-container"></div>
                </div>
                <span class="window-title-text">桌面背景</span>
                <div class="macos-window-controls">
                    <button class="close-btn"></button>
                </div>
            </div>
            <div class="macos-window-content">
                <div class="macos-content-inset" id="wallpaper-settings-window-content-inset" style="display: flex; flex-direction: column;">
                    <p style="margin-bottom: 8px; color: #000000;">选择桌面背景:</p>
                    <div id="preset-wallpapers-grid" class="grid grid-cols-3 gap-4 mb-4" style="flex-wrap: wrap;">
                        <!-- Preset wallpapers will be inserted here by JS -->
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-start; margin-top: auto;">
                        <p style="margin-bottom: 5px; color: #000000;">或者上传您自己的图片:</p>
                        <input type="file" id="upload-wallpaper-input" accept="image/*" class="macos-input" style="padding: 4px; border: 1px solid #707070; box-shadow: inset 1px 1px 0 #000000, inset -1px -1px 0 #DDDDDD;"/>
                    </div>
                    <div class="macos-modal-buttons" style="justify-content: flex-end; margin-top: 15px;">
                        <button class="macos-dialog-button default" id="apply-wallpaper-btn">应用</button>
                        <button class="macos-dialog-button" id="cancel-wallpaper-btn">取消</button>
                    </div>
                </div>
                <!-- Vertical Scrollbar for Wallpaper Settings Window -->
                <div class="macos-vertical-scrollbar" id="wallpaper-settings-vertical-scrollbar">
                    <div class="scroll-arrow up"></div>
                    <div class="scroll-track">
                        <div class="scroll-knob" id="wallpaper-settings-scroll-knob"></div>
                    </div>
                    <div class="scroll-arrow down"></div>
                </div>
            </div>
            <div class="macos-status-bar">
                <div class="status-button"></div>
                <div class="status-progress-bar">
                    <div class="progress-fill" style="width: 20%;"></div>
                </div>
                <span class="version-text">选择您的桌面背景</span>
                <div class="bottom-right-decorative-edge"></div>
            </div>
        </div>

        <!-- Theme settings window removed as per user request -->
    </div>

    <!-- Application Menu (simulating Apple Logo menu) -->
    <div id="application-menu" class="macos-application-menu">
        <div class="macos-application-menu-user">
            <div class="icon-container"></div>
            <span>Administrator</span>
        </div>
        <div class="macos-application-menu-item" data-action="message" data-title="关于此 Mac" data-message="经典 Mac OS 模拟版，版本 1.0。" data-icon="apple-logo-icon-svg">
            <div class="icon-container"></div>
            <span>关于此 Mac</span>
        </div>
        <div class="macos-application-menu-separator"></div>
        <div class="macos-application-menu-item has-submenu">
            <div class="icon-container"></div>
            <span>应用程序</span>
            <span class="macos-sub-menu-arrow">&gt;</span>
            <div class="macos-sub-menu">
                <div class="macos-application-menu-item" data-action="open-window" data-target="applications-window">
                    <div class="icon-container"></div>
                    <span>所有应用程序</span>
                </div>
                <div class="macos-application-menu-item" data-action="open-window" data-target="hello-window">
                    <div class="icon-container"></div>
                    <span>Hello! (示例)</span>
                </div>
                <div class="macos-application-menu-item" data-action="open-window" data-target="textedit-window">
                    <div class="icon-container"></div>
                    <span>文本编辑器</span>
                </div>
                <div class="macos-application-menu-item" data-action="open-window" data-target="on-off-dialog">
                    <div class="icon-container"></div>
                    <span>设置 (示例)</span>
                </div>
            </div>
        </div>
        <div class="macos-application-menu-item" data-action="message" data-title="偏好设置" data-message="偏好设置功能未实现。" data-icon="settings-icon-svg">
            <div class="icon-container"></div>
            <span>偏好设置</span>
        </div>
        <div class="macos-application-menu-item" data-action="message" data-title="服务" data-message="服务功能未实现。" data-icon="services-icon-svg">
            <div class="icon-container"></div>
            <span>服务</span>
        </div>
        <div class="macos-application-menu-separator"></div>
        <div class="macos-application-menu-item" data-action="message" data-title="强制退出" data-message="强制退出应用程序功能未实现。" data-icon="force-quit-icon-svg">
            <div class="icon-container"></div>
            <span>强制退出...</span>
        </div>
        <div class="macos-application-menu-item" data-action="message" data-title="睡眠" data-message="睡眠模式功能未实现。" data-icon="sleep-icon-svg">
            <div class="icon-container"></div>
            <span>睡眠</span>
        </div>
        <div class="macos-application-menu-item" data-action="message" data-title="关机" data-message="关机功能未实现。" data-icon="shutdown-icon-svg">
            <div class="icon-container"></div>
            <span>关机...</span>
        </div>
    </div>

    <script>
        const desktopArea = document.getElementById('desktop-area');
        const appleLogoMenuItem = document.getElementById('apple-logo-menu-item');
        const applicationMenu = document.getElementById('application-menu');
        const messageBoxTemplate = document.getElementById('message-box-template');
        const fileDialogTemplate = document.getElementById('file-dialog-template');
        const activeAppTitleDisplay = document.getElementById('active-app-title');
        const desktopBg = document.getElementById('desktop-bg');
        // Removed desktopIconsContainer as it's no longer a grid manager

        let activeDraggable = null; // Current draggable item (icon or window)
        let activeWindow = null;    // Current active window (for z-index and active titlebar)
        let initialX, initialY, xOffset = 0, yOffset = 0;
        let zIndexCounter = 50;     // Base z-index for windows

        // Store window references and their initial states (for maximize/restore)
        const windows = {
            'hello-window': { element: document.getElementById('hello-window'), title: 'Hello!', icon: 'hello-icon-svg' },
            'on-off-dialog': { element: document.getElementById('on-off-dialog'), title: '设置', icon: 'settings-icon-svg' },
            'databox-window': { element: document.getElementById('databox-window'), title: 'DataBox', icon: 'databox-icon-svg' },
            'trash-window': { element: document.getElementById('trash-window'), title: 'Trash', icon: 'trash-icon-svg' },
            'textedit-window': { element: document.getElementById('textedit-window'), title: '文本编辑器', icon: 'textedit-icon-svg' },
            'applications-window': { element: document.getElementById('applications-window'), title: '应用程序', icon: 'applications-icon-svg' },
            'wallpaper-settings-window': { element: document.getElementById('wallpaper-settings-window'), title: '桌面背景', icon: 'desktop-icon-svg' },
            // Desktop icons refer to the window elements they open, not the icons themselves.
        };

        // Mapping icon names to their SVG content (black, white, grey only, except for explicitly blue ones from screenshot)
        const iconSvgs = {
            'apple-logo-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.5 7.2C16.5 6.0 16.9 4.9 17.5 4.0C16.6 2.8 15.1 2.0 13.4 2.0C11.9 2.0 10.7 2.7 9.8 3.8C8.9 2.6 7.6 2.0 6.1 2.0C4.3 2.0 2.9 2.8 2.0 4.0C2.6 4.9 3.0 6.0 3.0 7.2C3.0 8.8 2.2 10.0 1.2 11.2C0.6 11.8 0.0 12.8 0.0 14.0C0.0 16.0 1.0 18.0 2.5 19.5C3.9 20.9 6.0 22.0 8.0 22.0C9.7 22.0 11.0 21.0 12.0 20.0C13.0 21.0 14.3 22.0 16.0 22.0C18.0 22.0 20.1 20.9 21.5 19.5C23.0 18.0 24.0 16.0 24.0 14.0C24.0 12.8 23.4 11.8 22.8 11.2C21.8 10.0 21.0 8.8 21.0 7.2C21.0 6.0 21.4 4.9 22.0 4.0C21.1 2.8 19.6 2.0 17.9 2.0C16.5 2.0 15.2 2.7 14.3 3.8C13.4 2.6 12.1 2.0 10.6 2.0Z" fill="#888888"/>
                    <path d="M12.0000 19.0000C12.0000 19.0000 12.0000 18.0000 12.0000 17.0000C12.0000 16.0000 12.0000 15.0000 12.0000 14.0000C12.0000 13.0000 12.0000 12.0000 12.0000 11.0000C12.0000 10.0000 12.0000 9.0000 12.0000 8.0000C12.0000 7.0000 12.0000 6.0000 12.0000 5.0000" fill="none"/>
                </svg>
            `,
            'network-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#E0E0E0" stroke="#000000" stroke-width="1"/>
                    <path d="M12 5C15.866 5 19 8.13401 19 12M12 8C14.2091 8 16 9.79086 16 12M12 11C12.5523 11 13 11.4477 13 12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11Z" stroke="#000000" stroke-width="1.5"/>
                </svg>
            `,
            'volume-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 3.5L9 8H4V16H9L14 20.5V3.5Z" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <path d="M17 8C18.5 9.5 19.5 11.5 19.5 14C19.5 16.5 18.5 18.5 17 20" stroke="#000000" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            `,
            'settings-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="8" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <circle cx="12" cy="12" r="3" fill="#000000"/>
                    <rect x="11" y="2" width="2" height="3" fill="#000000"/>
                    <rect x="11" y="19" width="2" height="3" fill="#000000"/>
                    <rect x="2" y="11" width="3" height="2" fill="#000000"/>
                    <rect x="19" y="11" width="3" height="2" fill="#000000"/>
                    <path d="M5.5 5.5L6.9 6.9M17.1 5.5L15.7 6.9M5.5 17.1L6.9 15.7M17.1 17.1L15.7 15.7" stroke="#000000" stroke-width="1"/>
                </svg>
            `,
            'desktop-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="4" width="20" height="14" rx="1" ry="1" fill="#BBBBBB" stroke="#000000" stroke-width="1"/>
                    <rect x="3" y="5" width="18" height="12" fill="#808080"/>
                    <rect x="8" y="18" width="8" height="2" fill="#000000"/>
                    <rect x="10" y="20" width="4" height="2" fill="#000000"/>
                </svg>
            `,
            'databox-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#C2C2C2" stroke="#000000" stroke-width="1"/>
                    <rect x="6" y="6" width="12" height="2" fill="#808080"/>
                    <rect x="6" y="9" width="12" height="2" fill="#A0A0A0"/>
                    <rect x="6" y="12" width="12" height="2" fill="#B0B0B0"/>
                    <rect x="6" y="15" width="12" height="2" fill="#D0D0D0"/>
                    <rect x="8" y="18" width="8" height="1" fill="#606060"/>
                    <rect x="8" y="5" width="8" height="1" fill="#606060"/>
                </svg>
            `,
            'trash-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 6h14l-1 14H6L5 6Z" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <rect x="9" y="3" width="6" height="2" fill="#A0A0A0" stroke="#000000" stroke-width="1"/>
                    <line x1="10" y1="9" x2="10" y2="17" stroke="#666666" stroke-width="1"/>
                    <line x1="12" y1="9" x2="12" y2="17" stroke="#666666" stroke-width="1"/>
                    <line x1="14" y1="9" x2="14" y2="17" stroke="#666666" stroke-width="1"/>
                    <line x1="8" y1="6" x2="16" y2="6" stroke="#000000" stroke-width="1.5"/>
                </svg>
            `,
            'blue-folder-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 4h7l2 3h13v13H2z" fill="#007AFF" stroke="#000000" stroke-width="1"/>
                    <path d="M2 5 L9 5 L11 8 L24 8 V19 H2 Z" fill="#3D8AFF" opacity="0.8"/>
                </svg>
            `,
            'generic-folder-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 4h7l2 3h13v13H2z" fill="#C2C2C2" stroke="#000000" stroke-width="1"/>
                    <path d="M2 5 L9 5 L11 8 L24 8 V19 H2 Z" fill="#E0E0E0" opacity="0.8"/>
                </svg>
            `,
            'document-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="5" y="3" width="14" height="18" rx="1" ry="1" fill="#FFFFFF" stroke="#000000" stroke-width="1"/>
                    <path d="M14 3L19 8H14V3Z" fill="#BBBBBB" stroke="#000000" stroke-width="1"/>
                    <rect x="7" y="6" width="10" height="2" fill="#CCCCCC"/>
                    <rect x="7" y="9" width="10" height="2" fill="#CCCCCC"/>
                    <rect x="7" y="12" width="10" height="2" fill="#CCCCCC"/>
                    <rect x="7" y="15" width="7" height="2" fill="#CCCCCC"/>
                </svg>
            `,
            'package-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 4L20 4V20L4 20L4 4Z" fill="#C0C0C0" stroke="#000000" stroke-width="1"/>
                    <path d="M4 4L12 12L20 4L4 4Z" fill="#E0E0E0" opacity="0.8"/>
                    <path d="M4 20L12 12L20 20L4 20Z" fill="#E0E0E0" opacity="0.8"/>
                    <line x1="4" y1="12" x2="20" y2="12" stroke="#000000" stroke-width="1"/>
                    <line x1="12" y1="4" x2="12" y2="20" stroke="#000000" stroke-width="1"/>
                </svg>
            `,
            'disk-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="6" width="18" height="12" rx="1" ry="1" fill="#9E9E9E" stroke="#000000" stroke-width="1"/>
                    <rect x="5" y="8" width="14" height="8" fill="#616161"/>
                    <rect x="9" y="10" width="6" height="4" fill="#424242"/>
                    <circle cx="12" cy="12" r="1.5" fill="#CCCCCC"/>
                    <rect x="10" y="10.5" width="4" height="3" fill="#9E9E9E"/>
                </svg>
            `,
            'filled-circle-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="9" fill="#007AFF" stroke="#000000" stroke-width="1"/>
                    <circle cx="12" cy="12" r="7" fill="#3D8AFF" stroke="#FFFFFF" stroke-width="0.5"/>
                </svg>
            `,
            'empty-circle-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="9" fill="#DDDDDD" stroke="#000000" stroke-width="1"/>
                    <circle cx="12" cy="12" r="7" fill="#F0F0F0" stroke="#CCCCCC" stroke-width="0.5"/>
                    <circle cx="12" cy="12" r="4" fill="none" stroke="#000000" stroke-width="1"/>
                </svg>
            `,
            'checkmark-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <path d="M6.5 12.5L10 16L17.5 8.5" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `,
            'square-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#E0E0E0" stroke="#000000" stroke-width="1"/>
                </svg>
            `,
            'macintosh-hd-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="2" ry="2" fill="#BBBBBB" stroke="#000000" stroke-width="1"/>
                    <rect x="6" y="6" width="12" height="12" rx="1" ry="1" fill="#EEEEEE"/>
                    <rect x="9" y="9" width="6" height="6" fill="#808080"/>
                    <line x1="12" y1="7" x2="12" y2="17" stroke="#000000" stroke-width="1.5"/>
                    <line x1="7" y1="12" x2="17" y2="12" stroke="#000000" stroke-width="1.5"/>
                </svg>
            `,
            'cd-rom-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#E0E0E0" stroke="#000000" stroke-width="1"/>
                    <circle cx="12" cy="12" r="8" fill="#F0F0F0"/>
                    <circle cx="12" cy="12" r="2" fill="#616161"/>
                    <line x1="12" y1="2" x2="12" y2="4" stroke="#000000" stroke-width="0.5"/>
                    <line x1="12" y1="20" x2="12" y2="22" stroke="#000000" stroke-width="0.5"/>
                    <line x1="2" y1="12" x2="4" y2="12" stroke="#000000" stroke-width="0.5"/>
                    <line x1="20" y1="12" x2="22" y2="12" stroke="#000000" stroke-width="0.5"/>
                </svg>
            `,
            'floppy-disk-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#9E9E9E" stroke="#000000" stroke-width="1"/>
                    <rect x="6" y="6" width="12" height="8" fill="#616161"/>
                    <rect x="9" y="15" width="6" height="3" fill="#424242"/>
                    <rect x="10" y="16" width="4" height="1" fill="#9E9E9E"/>
                </svg>
            `,
            'textedit-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#FFFFFF" stroke="#000000" stroke-width="1"/>
                    <line x1="7" y1="7" x2="17" y2="7" stroke="#616161" stroke-width="1.5"/>
                    <line x1="7" y1="10" x2="17" y2="10" stroke="#616161" stroke-width="1.5"/>
                    <line x1="7" y1="13" x2="17" y2="13" stroke="#616161" stroke-width="1.5"/>
                    <line x1="7" y1="16" x2="14" y2="16" stroke="#616161" stroke-width="1.5"/>
                </svg>
            `,
            'applications-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="7" height="7" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="0.5"/>
                    <rect x="14" y="3" width="7" height="7" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="0.5"/>
                    <rect x="3" y="14" width="7" height="7" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="0.5"/>
                    <rect x="14" y="14" width="7" height="7" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="0.5"/>
                    <circle cx="6.5" cy="6.5" r="1.5" fill="#000000"/>
                    <circle cx="17.5" cy="6.5" r="1.5" fill="#000000"/>
                    <circle cx="6.5" cy="17.5" r="1.5" fill="#000000"/>
                    <circle cx="17.5" cy="17.5" r="1.5" fill="#000000"/>
                </svg>
            `,
            'calculator-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="2" width="16" height="20" rx="1" ry="1" fill="#616161" stroke="#000000" stroke-width="1"/>
                    <rect x="6" y="4" width="12" height="4" fill="#E0E0E0" rx="0.5"/>
                    <rect x="6" y="9" width="3" height="3" fill="#CCCCCC"/>
                    <rect x="10.5" y="9" width="3" height="3" fill="#CCCCCC"/>
                    <rect x="15" y="9" width="3" height="3" fill="#CCCCCC"/>
                    <rect x="6" y="13" width="3" height="3" fill="#CCCCCC"/>
                    <rect x="10.5" y="13" width="3" height="3" fill="#CCCCCC"/>
                    <rect x="15" y="13" width="3" height="3" fill="#CCCCCC"/>
                    <rect x="6" y="17" width="3" height="3" fill="#CCCCCC"/>
                    <rect x="10.5" y="17" width="3" height="3" fill="#CCCCCC"/>
                    <rect x="15" y="17" width="3" height="3" fill="#A0A0A0"/>
                </svg>
            `,
            'paint-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#F0F0F0" stroke="#000000" stroke-width="1"/>
                    <polygon points="18 6 14 10 14 18 6 18 6 10 10 6 18 6" fill="#808080"/>
                    <circle cx="12" cy="12" r="3" fill="#CCCCCC" stroke="#000000" stroke-width="0.5"/>
                </svg>
            `,
            'game-controller-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="8" width="18" height="8" rx="3" ry="3" fill="#616161" stroke="#000000" stroke-width="1"/>
                    <circle cx="7" cy="12" r="1.5" fill="#000000"/>
                    <circle cx="17" cy="12" r="1.5" fill="#000000"/>
                    <rect x="10.5" y="10.5" width="3" height="3" fill="#424242"/>
                    <rect x="11.5" y="9.5" width="1" height="5" fill="#424242"/>
                    <rect x="9.5" y="11.5" width="5" height="1" fill="#424242"/>
                </svg>
            `,
            'browser-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="#E0E0E0" stroke="#000000" stroke-width="1"/>
                    <rect x="3" y="5" width="18" height="14" rx="1" ry="1" fill="#F0F0F0"/>
                    <rect x="4" y="6" width="16" height="3" fill="#BBBBBB"/>
                    <circle cx="7" cy="7.5" r="0.8" fill="#000000"/>
                    <circle cx="9" cy="7.5" r="0.8" fill="#000000"/>
                    <rect x="5" y="11" width="14" height="6" fill="#FFFFFF"/>
                </svg>
            `,
            'media-player-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="5" width="18" height="14" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <polygon points="10 8 16 12 10 16 10 8" fill="#000000"/>
                </svg>
            `,
            'mail-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="4" width="20" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <path d="M2 6l10 7 10-7" fill="none" stroke="#000000" stroke-width="1.5"/>
                    <path d="M2 6v12a1 1 0 001 1h18a1 1 0 001-1V6L12 13Z" fill="none" stroke="#000000" stroke-width="0.5"/>
                </svg>
            `,
            'user-avatar-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="7" r="4" fill="#BBBBBB" stroke="#000000" stroke-width="1"/>
                    <path d="M5 18c0-3.31 2.69-6 6-6h2c3.31 0 6 2.69 6 6v2H5v-2z" fill="#808080" stroke="#000000" stroke-width="1"/>
                </svg>
            `,
            'services-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <line x1="7" y1="7" x2="17" y2="17" stroke="#000000" stroke-width="2"/>
                    <line x1="17" y1="7" x2="7" y2="17" stroke="#000000" stroke-width="2"/>
                    <circle cx="12" cy="12" r="2" fill="#808080"/>
                </svg>
            `,
            'force-quit-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <line x1="8" y1="8" x2="16" y2="16" stroke="#000000" stroke-width="2"/>
                    <line x1="16" y1="8" x2="8" y2="16" stroke="#000000" stroke-width="2"/>
                </svg>
            `,
            'sleep-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <path d="M8 8 C 8 8 12 5 16 8 C 16 8 13 12 16 16 C 16 16 12 13 8 16 C 8 16 11 12 8 8 Z" fill="#000000"/>
                </svg>
            `,
            'shutdown-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <line x1="12" y1="6" x2="12" y2="18" stroke="#000000" stroke-width="2"/>
                    <circle cx="12" cy="18" r="2" fill="#000000"/>
                </svg>
            `,
            'info-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <rect x="11" y="8" width="2" height="2" fill="#000000"/>
                    <rect x="11" y="12" width="2" height="5" fill="#000000"/>
                </svg>
            `,
            'warning-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <polygon points="12 4 20 20 4 20 12 4" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <rect x="11" y="10" width="2" height="6" fill="#000000"/>
                    <rect x="11" y="17" width="2" height="2" fill="#000000"/>
                </svg>
            `,
            'error-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <line x1="8" y1="8" x2="16" y2="16" stroke="#000000" stroke-width="2"/>
                    <line x1="16" y1="8" x2="8" y2="16" stroke="#000000" stroke-width="2"/>
                </svg>
            `,
            'hello-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#F0F0F0" stroke="#000000" stroke-width="1"/>
                    <text x="12" y="16" font-family="Verdana" font-size="12" text-anchor="middle" fill="#000000" font-weight="bold">Hello</text>
                </svg>
            `,
            'new-file-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#FFFFFF" stroke="#000000" stroke-width="1"/>
                    <line x1="7" y1="7" x2="17" y2="7" stroke="#616161" stroke-width="1.5"/>
                    <line x1="7" y1="10" x2="17" y2="10" stroke="#616161" stroke-width="1.5"/>
                    <line x1="7" y1="13" x2="17" y2="13" stroke="#616161" stroke-width="1.5"/>
                    <line x1="7" y1="16" x2="14" y2="16" stroke="#616161" stroke-width="1.5"/>
                    <line x1="12" y1="5" x2="12" y2="19" stroke="#000000" stroke-width="2"/>
                    <line x1="5" y1="12" x2="19" y2="12" stroke="#000000" stroke-width="2"/>
                </svg>
            `,
            'open-file-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 4h7l2 3h13v13H2z" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <path d="M2 5 L9 5 L11 8 L24 8 V19 H2 Z" fill="#E0E0E0" opacity="0.8"/>
                    <path d="M12 10.5L16 14.5L12 18.5" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 14.5L8 10.5" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round"/>
                    <line x1="12" y1="14.5" x2="12" y2="10.5" stroke="#000000" stroke-width="2"/>
                </svg>
            `,
            'save-file-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="2" width="16" height="20" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <rect x="6" y="4" width="12" height="8" fill="#FFFFFF"/>
                    <rect x="7" y="5" width="10" height="6" fill="#DDDDDD"/>
                    <path d="M8 14h8V20h-8z" fill="#616161"/>
                    <line x1="10" y1="16" x2="14" y2="16" stroke="#FFFFFF" stroke-width="1"/>
                    <path d="M12 14L12 10" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `,
            'new-folder-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 4h7l2 3h13v13H2z" fill="#007AFF" stroke="#000000" stroke-width="1"/>
                    <path d="M2 5 L9 5 L11 8 L24 8 V19 H2 Z" fill="#3D8AFF" opacity="0.8"/>
                    <line x1="12" y1="10" x2="12" y2="16" stroke="#FFFFFF" stroke-width="2"/>
                    <line x1="9" y1="13" x2="15" y2="13" stroke="#FFFFFF" stroke-width="2"/>
                </svg>
            `,
            'get-info-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="4" y="4" width="16" height="16" rx="1" ry="1" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <rect x="11" y="8" width="2" height="2" fill="#000000"/>
                    <rect x="11" y="12" width="2" height="5" fill="#000000"/>
                </svg>
            `,
            'empty-trash-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 6h14l-1 14H6L5 6Z" fill="#CCCCCC" stroke="#000000" stroke-width="1"/>
                    <rect x="9" y="3" width="6" height="2" fill="#A0A0A0" stroke="#000000" stroke-width="1"/>
                    <line x1="10" y1="9" x2="10" y2="17" stroke="#666666" stroke-width="1"/>
                    <line x1="12" y1="9" x2="12" y2="17" stroke="#666666" stroke-width="1"/>
                    <line x1="14" y1="9" x2="14" y2="17" stroke="#666666" stroke-width="1"/>
                    <line x1="8" y1="6" x2="16" y2="6" stroke="#000000" stroke-width="1.5"/>
                </svg>
            `,
            'wallpaper-icon-svg': `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="5" width="18" height="14" rx="1" ry="1" fill="#E0E0E0" stroke="#000000" stroke-width="1"/>
                    <circle cx="12" cy="12" r="4" fill="#BBBBBB"/>
                    <circle cx="12" cy="12" r="1.5" fill="#666666"/>
                    <path d="M16 8 L18 8 L18 10 M8 16 L6 16 L6 14" stroke="#000000" stroke-width="1"/>
                </svg>
            `
        };

        const initialWindowStates = {};

        // Helper function to insert SVG HTML
        function insertSvg(element, svgKey) {
            if (element && iconSvgs[svgKey]) {
                element.innerHTML = '';
                element.insertAdjacentHTML('beforeend', iconSvgs[svgKey]);
            } else if (element) {
                console.warn(`SVG content for key '${svgKey}' not found.`);
                element.innerHTML = '';
            }
        }

        // --- Global Drag Logic (for icons and windows) ---
        function globalDragStart(e) {
            const isWindowTitlebar = e.target.classList.contains('macos-window-titlebar') || e.target.closest('.macos-window-titlebar');
            const isDesktopIcon = e.currentTarget.classList.contains('macos-desktop-icon');

            if (e.button !== 0) return;

            let targetElement = null;

            if (isWindowTitlebar) {
                targetElement = e.currentTarget.closest('.macos-window');
                activateWindow(targetElement);
            } else if (isDesktopIcon) {
                targetElement = e.currentTarget;
                document.querySelectorAll('.macos-desktop-icon').forEach(icon => icon.classList.remove('selected'));
                targetElement.classList.add('selected');
                // Since all desktop icons are now absolutely positioned, no need to change position type during drag
            } else {
                return;
            }
            
            activeDraggable = targetElement;
            activeDraggable.classList.add('dragging');

            // Get the bounding rect of the draggable element relative to the viewport
            const itemRect = activeDraggable.getBoundingClientRect();
            // Calculate offsets relative to the desktop area's top-left corner
            const desktopRect = desktopArea.getBoundingClientRect();
            
            // Calculate initial click offset within the element
            initialX = e.clientX;
            initialY = e.clientY;
            xOffset = initialX - itemRect.left;
            yOffset = initialY - itemRect.top;
            
            document.addEventListener('mousemove', globalDrag);
            document.addEventListener('mouseup', globalDragEnd);

            e.preventDefault();
            e.stopPropagation();
        }

        function globalDrag(e) {
            if (activeDraggable === null) return;
            e.preventDefault();

            const desktopRect = desktopArea.getBoundingClientRect();
            const itemRect = activeDraggable.getBoundingClientRect(); // Get current dimensions
            
            // Calculate new position relative to desktopArea
            let newX = e.clientX - desktopRect.left - xOffset;
            let newY = e.clientY - desktopRect.top - yOffset;

            // Constrain movement within desktop area
            newX = Math.max(0, newX); // left boundary
            newX = Math.min(desktopRect.width - itemRect.width, newX); // right boundary
            newY = Math.max(22, newY); // top boundary (below menubar)
            newY = Math.min(desktopRect.height - itemRect.height, newY); // bottom boundary

            activeDraggable.style.left = `${newX}px`;
            activeDraggable.style.top = `${newY}px`;
        }

        function globalDragEnd() {
            if (activeDraggable === null) return;
            activeDraggable.classList.remove('dragging');
            // Icons now stay at their dropped absolute position
            
            // Clear selection if not just double-clicked (which triggers its own action)
            if (!activeDraggable.classList.contains('just-double-clicked')) {
                document.querySelectorAll('.macos-desktop-icon').forEach(icon => icon.classList.remove('selected'));
            }
            activeDraggable.classList.remove('just-double-clicked'); // Reset flag
            activeDraggable = null;
            document.removeEventListener('mousemove', globalDrag);
            document.removeEventListener('mouseup', globalDragEnd);
        }

        // --- Desktop Icon Functions ---
        const ICON_WIDTH = 70;
        const ICON_HEIGHT = 80;
        const ICON_GAP_X = 15; // Increased gap for better spacing
        const ICON_GAP_Y = 15;
        const DESKTOP_LEFT_START = 20;
        const DESKTOP_TOP_START = 30; // Below menubar

        // Function to find the next available position for a new icon
        function getNextIconPosition() {
            const existingIcons = Array.from(document.querySelectorAll('.macos-desktop-icon'));
            const desktopWidth = desktopArea.clientWidth;
            const desktopHeight = desktopArea.clientHeight;
            
            let bestX = DESKTOP_LEFT_START;
            let bestY = DESKTOP_TOP_START;

            // Simple grid-like placement
            // Iterate through potential positions to find the first available spot
            let column = 0;
            let row = 0;

            const maxColumns = Math.floor((desktopWidth - DESKTOP_LEFT_START) / (ICON_WIDTH + ICON_GAP_X));
            
            // Generate all possible positions in a grid
            const possiblePositions = [];
            for (let r = 0; ; r++) {
                let y = DESKTOP_TOP_START + r * (ICON_HEIGHT + ICON_GAP_Y);
                if (y + ICON_HEIGHT > desktopHeight) break; // Exceeds desktop height

                for (let c = 0; c < maxColumns; c++) {
                    let x = DESKTOP_LEFT_START + c * (ICON_WIDTH + ICON_GAP_X);
                    if (x + ICON_WIDTH > desktopWidth) break; // Exceeds desktop width
                    possiblePositions.push({ x, y });
                }
            }

            // Find the first possible position that doesn't collide with existing icons
            for (const pos of possiblePositions) {
                if (!isCollision(pos.x, pos.y, ICON_WIDTH, ICON_HEIGHT, existingIcons)) {
                    return { left: pos.x, top: pos.y };
                }
            }
            
            // Fallback: if no non-colliding spot found, just place it after the last icon or at a default spot
            // This case should ideally not be reached if desktop has space
            if (existingIcons.length > 0) {
                const lastIcon = existingIcons[existingIcons.length - 1];
                let lastLeft = parseFloat(lastIcon.style.left) || 0;
                let lastTop = parseFloat(lastIcon.style.top) || 0;
                
                let nextLeft = lastLeft + ICON_WIDTH + ICON_GAP_X;
                let nextTop = lastTop;

                if (nextLeft + ICON_WIDTH > desktopWidth - DESKTOP_LEFT_START) { // Check if it goes beyond visual right edge
                    nextLeft = DESKTOP_LEFT_START;
                    nextTop += ICON_HEIGHT + ICON_GAP_Y;
                }
                return { left: nextLeft, top: nextTop };
            }

            return { left: DESKTOP_LEFT_START, top: DESKTOP_TOP_START }; // Default for first icon
        }

        // Improved collision detection
        function isCollision(x, y, width, height, existingIcons) {
            for (const icon of existingIcons) {
                // Get the current position of the icon element, which are its style.left and style.top values
                const iconLeft = parseFloat(icon.style.left);
                const iconTop = parseFloat(icon.style.top);
                const iconWidth = icon.offsetWidth;
                const iconHeight = icon.offsetHeight;

                // Check for overlap
                if (x < iconLeft + iconWidth &&
                    x + width > iconLeft &&
                    y < iconTop + iconHeight &&
                    y + height > iconTop) {
                    return true; // Collision detected
                }
            }
            return false; // No collision
        }

        // Function to create a new desktop icon dynamically
        function createNewDesktopIcon(name, iconSvgKey) {
            const newIcon = document.createElement('div');
            newIcon.id = `desktop-icon-${Date.now()}`; 
            newIcon.classList.add('macos-desktop-icon');

            const iconContainer = document.createElement('div');
            iconContainer.classList.add('icon-container');
            insertSvg(iconContainer, iconSvgKey);

            const iconNameSpan = document.createElement('span');
            iconNameSpan.textContent = name;

            newIcon.appendChild(iconContainer);
            newIcon.appendChild(iconNameSpan);

            // Set initial position
            const { left, top } = getNextIconPosition();
            newIcon.style.left = `${left}px`;
            newIcon.style.top = `${top}px`;

            // Add drag and double-click listeners
            newIcon.addEventListener('mousedown', globalDragStart);
            newIcon.addEventListener('dblclick', (e) => {
                e.currentTarget.classList.add('just-double-clicked'); // Flag to prevent immediate deselection
                showMessageBox('文件夹', `"${name}" 文件夹已打开 (模拟)。`, iconSvgKey);
            });
            newIcon.addEventListener('click', (e) => {
                // Only select if not dragging or just finished double-clicking
                if (activeDraggable === e.currentTarget || e.currentTarget.classList.contains('just-double-clicked')) {
                    // Reset double-click flag if it was just double-clicked
                    e.currentTarget.classList.remove('just-double-clicked');
                    return;
                }
                document.querySelectorAll('.macos-desktop-icon').forEach(i => i.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
            });

            desktopArea.appendChild(newIcon); // Append to desktopArea directly
            showMessageBox('新建文件夹', `文件夹 "${name}" 已创建。`, iconSvgKey);
        }

        // Apply drag listeners to existing icons on load
        document.querySelectorAll('.macos-desktop-icon').forEach(icon => {
            icon.addEventListener('mousedown', globalDragStart);
            icon.addEventListener('dblclick', (e) => {
                e.currentTarget.classList.add('just-double-clicked'); // Flag to prevent immediate deselection
                const iconId = e.currentTarget.id;
                // If the desktop icon corresponds to a defined window, open it.
                if (iconId === 'databox-icon' && windows['databox-window']) {
                    openWindow(windows['databox-window'].element, windows['databox-window'].title, windows['databox-window'].icon);
                } else if (iconId === 'trash-icon' && windows['trash-window']) {
                    openWindow(windows['trash-window'].element, windows['trash-window'].title, windows['trash-window'].icon);
                } else if (e.currentTarget.querySelector('span').textContent.includes('Folder')) {
                    // For dynamically created folders, show a generic "opened" message
                    showMessageBox('文件夹', `"${e.currentTarget.querySelector('span').textContent}" 文件夹已打开。`, 'generic-folder-icon-svg');
                } else {
                    showMessageBox('应用程序', `"${e.currentTarget.querySelector('span').textContent}" 应用程序功能未实现。`, 'info-icon-svg');
                }
            });
            icon.addEventListener('click', (e) => {
                // Only select if not dragging or just finished double-clicking
                if (activeDraggable === e.currentTarget || e.currentTarget.classList.contains('just-double-clicked')) {
                    e.currentTarget.classList.remove('just-double-clicked'); // Reset flag
                    return;
                }
                document.querySelectorAll('.macos-desktop-icon').forEach(i => i.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
            });
        });

        // --- Window Management Functions ---
        function activateWindow(windowElement) {
            if (windowElement.classList.contains('message-box')) {
                return;
            }

            zIndexCounter++;
            windowElement.style.zIndex = zIndexCounter;

            if (activeWindow) {
                activeWindow.querySelector('.macos-window-titlebar').classList.add('inactive');
            }
            
            activeWindow = windowElement;
            activeWindow.querySelector('.macos-window-titlebar').classList.remove('inactive');
            activeAppTitleDisplay.textContent = windowElement.querySelector('.macos-window-titlebar .window-title-text').textContent;
        }

        function openWindow(windowElement, title, iconSvgKey) {
            // Store initial position and size for maximize/restore if not already stored
            if (!initialWindowStates[windowElement.id] || windowElement.style.display === 'none') {
                 // Capture current position and size only if not maximized or currently hidden
                 initialWindowStates[windowElement.id] = {
                    top: windowElement.style.top,
                    left: windowElement.style.left,
                    width: windowElement.style.width,
                    height: windowElement.style.height
                };
            }

            windowElement.style.display = 'flex'; // Changed to flex to enable column layout
            const titlebarSpan = windowElement.querySelector('.macos-window-titlebar .window-title-text');
            if (titlebarSpan) titlebarSpan.textContent = title;
            
            const windowLogoArea = windowElement.querySelector('.macos-window-titlebar .window-logo-area .icon-container');
            if (windowLogoArea && iconSvgKey) {
                insertSvg(windowLogoArea, iconSvgKey);
                windowLogoArea.style.display = 'flex'; // Ensure it's visible
            } else if (windowLogoArea) {
                windowLogoArea.style.display = 'none'; // Hide if no icon
            }

            activateWindow(windowElement);

            const titlebar = windowElement.querySelector('.macos-window-titlebar');
            if (titlebar) {
                titlebar.removeEventListener('mousedown', globalDragStart); // Remove previous listener to avoid duplicates
                titlebar.addEventListener('mousedown', globalDragStart);
            }

            // Bind window control buttons
            windowElement.querySelectorAll('.close-btn').forEach(btn => {
                btn.onclick = () => closeWindow(windowElement);
            });
            windowElement.querySelectorAll('.minimize-btn').forEach(btn => {
                if(btn) {
                    btn.onclick = () => {
                        windowElement.style.display = 'none';
                    };
                }
            });
            windowElement.querySelectorAll('.maximize-btn').forEach(btn => {
                if (btn) {
                    let isMaximized = false;
                    btn.onclick = () => {
                        if (isMaximized) {
                            // Restore from initial state
                            windowElement.style.top = initialWindowStates[windowElement.id].top;
                            windowElement.style.left = initialWindowStates[windowElement.id].left;
                            windowElement.style.width = initialWindowStates[windowElement.id].width;
                            windowElement.style.height = initialWindowStates[windowElement.id].height;
                            windowElement.style.resize = 'both';
                        } else {
                            // Save current state before maximizing
                            initialWindowStates[windowElement.id] = {
                                top: windowElement.style.top,
                                left: windowElement.style.left,
                                width: windowElement.style.width,
                                height: windowElement.style.height
                            };
                            // Maximize
                            windowElement.style.top = '22px'; // Below menubar
                            windowElement.style.left = '0px';
                            windowElement.style.width = '100%';
                            windowElement.style.height = `calc(100% - 22px)`;
                            windowElement.style.resize = 'none';
                        }
                        isMaximized = !isMaximized;
                    };
                }
            });
            
            // Bring window to front on any click
            windowElement.addEventListener('mousedown', (e) => {
                // Ensure click is not on controls or titlebar (which handle their own drag/activation)
                if (!e.target.closest('.macos-window-controls') && !e.target.closest('.macos-window-titlebar')) {
                    activateWindow(windowElement);
                }
            });

            // Initialize custom scrollbar for this window if it has one
            const contentInset = windowElement.querySelector('.macos-content-inset');
            const verticalScrollbar = windowElement.querySelector('.macos-vertical-scrollbar');
            if (contentInset && verticalScrollbar) {
                setupCustomScrollbar(contentInset, verticalScrollbar);
            }
        }

        function closeWindow(windowElement) {
            windowElement.style.display = 'none';
            if (activeWindow === windowElement) {
                activeWindow = null;
                activeAppTitleDisplay.textContent = 'Finder';
            }
        }

        // --- Custom Message Box Function ---
        function showMessageBox(title, message, iconSvgKey = 'info-icon-svg') {
            const msgBoxClone = messageBoxTemplate.cloneNode(true);
            msgBoxClone.id = '';

            const msgTitle = msgBoxClone.querySelector('#message-box-title');
            const msgText = msgBoxClone.querySelector('#message-box-text');
            const msgIconContainer = msgBoxClone.querySelector('#message-box-icon-container');
            const msgOkButton = msgBoxClone.querySelector('#message-box-ok-button');
            const closeBtn = msgBoxClone.querySelector('.close-btn');

            msgTitle.textContent = title;
            msgText.textContent = message;

            insertSvg(msgIconContainer, iconSvgKey);
            // Message box icon container is already within the content area, no need for window-icon-container in titlebar
            // For message boxes, the titlebar logo is usually not present or is a generic system icon.
            // Let's explicitly set the logo for the message box titlebar if it exists.
            const msgBoxLogoArea = msgBoxClone.querySelector('.macos-window-titlebar .window-logo-area .icon-container');
            if (msgBoxLogoArea) {
                 insertSvg(msgBoxLogoArea, iconSvgKey); // Use the message icon as titlebar logo too
            }


            msgBoxClone.style.display = 'flex';
            document.body.appendChild(msgBoxClone);

            // Message boxes are not draggable or resizable
            msgBoxClone.querySelector('.macos-window-titlebar').style.cursor = 'default';
            msgBoxClone.style.resize = 'none';

            const closeMessageBox = () => {
                msgBoxClone.remove();
            };

            msgOkButton.onclick = closeMessageBox;
            if (closeBtn) closeBtn.onclick = closeMessageBox;
            msgOkButton.focus(); // Focus OK button for easy Enter key press
        }

        // --- File Dialog (Save/Open/New Folder) ---
        function showFileDialog(type, defaultName = '') {
            return new Promise((resolve, reject) => {
                const dialogClone = fileDialogTemplate.cloneNode(true);
                dialogClone.id = 'active-file-dialog';

                const dialogMessage = dialogClone.querySelector('#file-dialog-message');
                const dialogInput = dialogClone.querySelector('#file-dialog-input');
                const dialogOkButton = dialogClone.querySelector('#file-dialog-ok');
                const dialogCancelButton = dialogClone.querySelector('#file-dialog-cancel');

                if (type === 'save') {
                    dialogMessage.textContent = '将文件另存为:';
                } else if (type === 'open') {
                    dialogMessage.textContent = '打开文件:';
                } else if (type === 'new-folder') {
                    dialogMessage.textContent = '新建文件夹名称:';
                }
                
                dialogInput.value = defaultName;
                dialogInput.focus();

                document.body.appendChild(dialogClone);

                const closeDialog = () => {
                    dialogClone.remove();
                    reject('Dialog closed');
                };

                dialogOkButton.onclick = () => {
                    const filename = dialogInput.value.trim();
                    if (filename) {
                        dialogClone.remove();
                        resolve(filename);
                    } else {
                        showMessageBox('错误', '名称不能为空。', 'error-icon-svg');
                    }
                };

                dialogCancelButton.onclick = closeDialog;
                dialogInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        dialogOkButton.click();
                    }
                });
            });
        }

        // --- Custom Scrollbar Logic ---
        function setupCustomScrollbar(contentElement, scrollbarElement) {
            const scrollTrack = scrollbarElement.querySelector('.scroll-track');
            const scrollKnob = scrollbarElement.querySelector('.scroll-knob');
            const upArrow = scrollbarElement.querySelector('.scroll-arrow.up');
            const downArrow = scrollbarElement.querySelector('.scroll-arrow.down');

            let isKnobDragging = false;
            let initialKnobY;
            let initialMouseY;

            // Update knob position and size based on content scroll
            function updateScrollbar() {
                const contentHeight = contentElement.scrollHeight;
                const visibleHeight = contentElement.clientHeight;
                const scrollRatio = visibleHeight / contentHeight;

                if (scrollRatio >= 1) {
                    // Content fits, hide scrollbar
                    scrollbarElement.style.display = 'none';
                    return;
                } else {
                    scrollbarElement.style.display = 'flex';
                }

                const trackHeight = scrollTrack.clientHeight;
                const knobHeight = Math.max(15, trackHeight * scrollRatio); // Min knob height
                scrollKnob.style.height = `${knobHeight}px`;

                const maxScrollTop = contentHeight - visibleHeight;
                const maxKnobTop = trackHeight - knobHeight;
                
                const knobTop = (contentElement.scrollTop / maxScrollTop) * maxKnobTop;
                scrollKnob.style.top = `${knobTop}px`;
            }

            // Handle knob drag start
            scrollKnob.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                isKnobDragging = true;
                initialKnobY = scrollKnob.offsetTop;
                initialMouseY = e.clientY;
                scrollKnob.classList.add('dragging');
                document.body.style.cursor = 'grabbing'; // Change cursor globally
                e.preventDefault();
            });

            // Handle knob drag
            document.addEventListener('mousemove', (e) => {
                if (!isKnobDragging) return;
                e.preventDefault();

                const dy = e.clientY - initialMouseY;
                let newKnobTop = initialKnobY + dy;

                const trackHeight = scrollTrack.clientHeight;
                const knobHeight = scrollKnob.clientHeight;
                const maxKnobTop = trackHeight - knobHeight;

                newKnobTop = Math.max(0, Math.min(newKnobTop, maxKnobTop));
                scrollKnob.style.top = `${newKnobTop}px`;

                const scrollRatio = newKnobTop / maxKnobTop;
                contentElement.scrollTop = scrollRatio * (contentElement.scrollHeight - contentElement.clientHeight);
            });

            // Handle knob drag end
            document.addEventListener('mouseup', () => {
                if (isKnobDragging) {
                    isKnobDragging = false;
                    scrollKnob.classList.remove('dragging');
                    document.body.style.cursor = 'default'; // Reset cursor
                }
            });

            // Handle scroll arrows
            let scrollInterval = null;
            const scrollStep = 15; // Pixels to scroll per step

            const startScrolling = (direction) => {
                stopScrolling(); // Clear any existing interval
                scrollInterval = setInterval(() => {
                    if (direction === 'up') {
                        contentElement.scrollTop -= scrollStep;
                    } else {
                        contentElement.scrollTop += scrollStep;
                    }
                }, 50); // Adjust scroll speed
            };

            const stopScrolling = () => {
                if (scrollInterval) {
                    clearInterval(scrollInterval);
                    scrollInterval = null;
                }
            };

            upArrow.addEventListener('mousedown', () => startScrolling('up'));
            downArrow.addEventListener('mousedown', () => startScrolling('down'));
            upArrow.addEventListener('mouseup', stopScrolling);
            downArrow.addEventListener('mouseup', stopScrolling);
            upArrow.addEventListener('mouseleave', stopScrolling);
            downArrow.addEventListener('mouseleave', stopScrolling);

            // Update scrollbar when content scrolls
            contentElement.addEventListener('scroll', updateScrollbar);
            // Update scrollbar when window is resized (content dimensions might change)
            window.addEventListener('resize', updateScrollbar);
            // Initial update
            updateScrollbar();
        }


        // --- Other UI Element Interactions ---
        // Example: On/Off Toggle Button
        const onToggleBtn = document.getElementById('on-toggle-btn');
        const offToggleBtn = document.getElementById('off-toggle-btn');
        if (onToggleBtn && offToggleBtn) {
            onToggleBtn.addEventListener('click', () => {
                onToggleBtn.classList.add('active');
                offToggleBtn.classList.remove('active');
                showMessageBox('开关', 'On 已激活。', 'info-icon-svg');
            });
            offToggleBtn.addEventListener('click', () => {
                offToggleBtn.classList.add('active');
                onToggleBtn.classList.remove('active');
                showMessageBox('开关', 'Off 已激活。', 'info-icon-svg');
            });
        }
        const onOffOkButton = document.getElementById('on-off-ok-button');
        if (onOffOkButton) {
            onOffOkButton.addEventListener('click', () => {
                showMessageBox('设置', 'Mac 风格设置已保存 (模拟)。', 'info-icon-svg');
                closeWindow(document.getElementById('on-off-dialog'));
            });
        }

        // Click outside icons/windows/menus to deselect and close application menu
        document.body.addEventListener('mousedown', (e) => {
            if (applicationMenu.classList.contains('active') && !applicationMenu.contains(e.target) && e.target !== appleLogoMenuItem && !e.target.closest('.macos-menubar-item')) {
                applicationMenu.classList.remove('active');
            }
            document.querySelectorAll('.macos-menubar-sub-menu').forEach(menu => {
                if (!menu.contains(e.target) && !e.target.closest('.macos-menubar-item')) {
                    menu.style.display = 'none';
                }
            });

            // Deselect icons only if click is not on an icon, a window, menubar, or during active drag/double click
            if (!e.target.closest('.macos-desktop-icon') && !e.target.closest('.macos-window') && !e.target.closest('.macos-menubar') && !activeDraggable && !e.target.classList.contains('just-double-clicked')) {
                 document.querySelectorAll('.macos-desktop-icon').forEach(icon => icon.classList.remove('selected'));
            }
        });

        // --- Application Menu (Apple Logo Menu) ---
        appleLogoMenuItem.addEventListener('click', (e) => {
            e.stopPropagation();
            applicationMenu.classList.toggle('active');
            applicationMenu.style.left = appleLogoMenuItem.offsetLeft + 'px';
        });

        document.querySelectorAll('.macos-application-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (item.classList.contains('has-submenu')) {
                    e.stopPropagation();
                    return;
                }

                const action = item.dataset.action;
                const targetId = item.dataset.target;
                const title = item.dataset.title || item.querySelector('span').textContent;
                const message = item.dataset.message;
                const iconSvgKey = item.dataset.icon;

                applicationMenu.classList.remove('active');

                if (action === 'open-window' && windows[targetId] && windows[targetId].element) {
                    openWindow(windows[targetId].element, windows[targetId].title, windows[targetId].icon);
                } else if (action === 'message') {
                    showMessageBox(title, message, iconSvgKey);
                } else {
                    showMessageBox(title, `"${title}" 功能未实现。`, 'info-icon-svg');
                }
            });

            const subMenu = item.querySelector('.macos-sub-menu');
            if (subMenu) {
                item.addEventListener('mouseenter', () => {
                    item.closest('.macos-application-menu, .macos-sub-menu').querySelectorAll('.macos-sub-menu').forEach(menu => {
                        if (menu !== subMenu) {
                            menu.classList.remove('active');
                        }
                    });
                    subMenu.classList.add('active');
                });
                item.addEventListener('mouseleave', (e) => {
                    if (!item.contains(e.relatedTarget) && !subMenu.contains(e.relatedTarget)) {
                        subMenu.classList.remove('active');
                    }
                });
            }
        });

        // --- Main Menubar File Menu (Finder context) ---
        document.getElementById('finder-file-menu-item').addEventListener('click', (e) => {
            document.querySelectorAll('.macos-menubar-sub-menu').forEach(menu => {
                if (menu.parentElement !== e.currentTarget) {
                    menu.style.display = 'none';
                }
            });
            const subMenu = e.currentTarget.querySelector('.macos-menubar-sub-menu');
            if (subMenu) {
                subMenu.style.display = subMenu.style.display === 'flex' ? 'none' : 'flex';
                e.stopPropagation();
            }
        });
        
        document.querySelectorAll('#finder-file-menu-item .macos-menubar-sub-menu-item').forEach(item => {
            item.addEventListener('click', async (e) => {
                const action = e.currentTarget.dataset.action;
                const selectedIcon = document.querySelector('.macos-desktop-icon.selected');
                
                e.currentTarget.closest('.macos-menubar-sub-menu').style.display = 'none';

                if (action === 'new-folder') {
                    try {
                        const folderName = await showFileDialog('new-folder', '新建文件夹');
                        createNewDesktopIcon(folderName, 'generic-folder-icon-svg');
                    } catch (error) {
                        console.log("New folder dialog cancelled or error:", error);
                    }
                } else if (action === 'get-info') {
                    if (selectedIcon) {
                        const iconName = selectedIcon.querySelector('span').textContent;
                        showMessageBox('信息', `"${iconName}" 的信息 (模拟)。`, 'get-info-icon-svg');
                    } else {
                        showMessageBox('信息', '请先选择一个桌面图标。', 'info-icon-svg');
                    }
                } else if (action === 'empty-trash') {
                    const trashWindowContent = document.querySelector('#trash-window .macos-content-inset');
                    if (trashWindowContent) {
                        trashWindowContent.innerHTML = `
                            <div class="icon-container" style="width:64px; height:64px; margin-bottom: 10px;"></div>
                            <p style="font-size: 13px; color: #000000;">回收站是空的。</p>
                            <p style="font-size: 12px; color: #808080; margin-top: 5px;">请将不需要的文件拖到这里。</p>
                        `;
                        insertSvg(trashWindowContent.querySelector('.icon-container'), 'trash-icon-svg');
                        document.querySelector('#trash-window .macos-status-bar .version-text').textContent = '0 个项目';
                        showMessageBox('清倒废纸篓', '废纸篓已清空。', 'empty-trash-icon-svg');
                    }
                } else if (action === 'close-active-window') {
                    if (activeWindow && !activeWindow.classList.contains('message-box')) {
                        closeWindow(activeWindow);
                    } else {
                        showMessageBox('关闭窗口', '没有活动的应用程序窗口可以关闭。', 'info-icon-svg');
                    }
                } else if (action === 'change-wallpaper') {
                    openWindow(windows['wallpaper-settings-window'].element, windows['wallpaper-settings-window'].title, windows['wallpaper-settings-window'].icon);
                }
            });
        });

        // --- Main Menubar Edit Menu (no longer for theme settings) ---
        // The 'Edit' menu item itself remains, but its content for theme changing is removed in HTML.
        document.getElementById('edit-menu-item').addEventListener('click', (e) => {
            document.querySelectorAll('.macos-menubar-sub-menu').forEach(menu => {
                if (menu.parentElement !== e.currentTarget) {
                    menu.style.display = 'none';
                }
            });
            const subMenu = e.currentTarget.querySelector('.macos-menubar-sub-menu');
            if (subMenu) {
                // If there are no items in the submenu after removing "更改主题...", it will just be an empty dropdown.
                // You might add other standard 'Edit' menu items here (e.g., Cut, Copy, Paste - not implemented yet).
                if (subMenu.children.length === 0) {
                    showMessageBox('编辑菜单', '此菜单目前没有可用功能。', 'info-icon-svg');
                }
                subMenu.style.display = subMenu.style.display === 'flex' ? 'none' : 'flex';
                e.stopPropagation();
            }
        });

        // --- TextEdit Specific Functions ---
        const textEditWindow = document.getElementById('textedit-window');
        const textEditTextArea = document.getElementById('textedit-textarea');
        const textEditTitleDisplay = document.getElementById('textedit-window-title');
        const textEditStatusBarText = document.getElementById('textedit-status-text'); // Changed ID
        const summarizeBtn = document.getElementById('summarize-btn');
        const continueBtn = document.getElementById('continue-btn');

        let currentFileName = "无标题";
        let isContentSaved = true;

        // Function to update status bar (word/character count)
        function updateTextEditStatusBar() {
            const text = textEditTextArea.value;
            const charCount = text.length;
            const wordCount = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const lineCount = text.split('\n').length;
            textEditStatusBarText.textContent = `行: ${lineCount}, 列: ${text.split('\n').pop().length} | 字数: ${wordCount}, 字符数: ${charCount}`;
            isContentSaved = false;
            updateTextEditTitle();
        }

        // Function to update TextEdit window title with save status
        function updateTextEditTitle() {
            const titlePrefix = isContentSaved ? '' : '• ';
            textEditTitleDisplay.textContent = `${titlePrefix}${currentFileName}`;
        }

        // New document function
        function newTextEditDocument() {
            if (!isContentSaved && textEditTextArea.value.trim() !== "") {
                showMessageBox('警告', '当前文档未保存。是否继续创建新文档？所有未保存的更改将丢失。', 'warning-icon-svg');
                setTimeout(() => {
                    textEditTextArea.value = '';
                    currentFileName = '无标题';
                    isContentSaved = true;
                    updateTextEditStatusBar();
                    updateTextEditTitle();
                }, 1500);
            } else {
                textEditTextArea.value = '';
                currentFileName = '无标题';
                isContentSaved = true;
                updateTextEditStatusBar();
                updateTextEditTitle();
            }
        }

        // Save document function
        async function saveTextEditDocument(saveAs = false) {
            let filenameToSave = currentFileName;
            if (saveAs || currentFileName === "无标题") {
                try {
                    filenameToSave = await showFileDialog('save', currentFileName === "无标题" ? "新文档.txt" : currentFileName);
                    if (!filenameToSave.endsWith('.txt')) {
                        filenameToSave += '.txt';
                    }
                } catch (e) {
                    console.log("Save dialog cancelled.");
                    return;
                }
            }

            try {
                localStorage.setItem(`textedit_doc_${filenameToSave}`, textEditTextArea.value);
                currentFileName = filenameToSave;
                isContentSaved = true;
                updateTextEditTitle();
                showMessageBox('保存成功', `文件 "${currentFileName}" 已保存。`, 'info-icon-svg');
            } catch (error) {
                showMessageBox('错误', `保存文件时出错: ${error.message}`, 'error-icon-svg');
                console.error("Error saving document:", error);
            }
        }

        // Open document function
        async function openTextEditDocument() {
            if (!isContentSaved && textEditTextArea.value.trim() !== "") {
                 showMessageBox('警告', '当前文档未保存。是否继续打开新文档？所有未保存的更改将丢失。', 'warning-icon-svg');
                 setTimeout(async () => {
                    await promptAndLoadDocument();
                 }, 1500);
            } else {
                await promptAndLoadDocument();
            }
        }

        async function promptAndLoadDocument() {
            try {
                const filenameToOpen = await showFileDialog('open', '');
                const content = localStorage.getItem(`textedit_doc_${filenameToOpen}`);
                if (content !== null) {
                    textEditTextArea.value = content;
                    currentFileName = filenameToOpen;
                    isContentSaved = true;
                    updateTextEditStatusBar();
                    updateTextEditTitle();
                    showMessageBox('打开成功', `文件 "${currentFileName}" 已打开。`, 'info-icon-svg');
                } else {
                    showMessageBox('错误', `文件 "${filenameToOpen}" 未找到。`, 'error-icon-svg');
                }
            } catch (e) {
                console.log("Open dialog cancelled or file not found.");
            }
        }

        // Function to show/hide loading overlay
        function toggleLoading(windowElement, show) {
            let loadingOverlay = windowElement.querySelector('.loading-overlay');
            if (show) {
                if (!loadingOverlay) {
                    loadingOverlay = document.createElement('div');
                    loadingOverlay.classList.add('loading-overlay');
                    loadingOverlay.innerHTML = '<div class="spinner"></div><span>正在处理...</span>';
                    windowElement.appendChild(loadingOverlay);
                }
                loadingOverlay.style.display = 'flex';
            } else {
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
        }

        async function performLLMOperation(operationType) {
            const currentText = textEditTextArea.value;
            if (!currentText.trim()) {
                showMessageBox('错误', '文本区域为空，请先输入一些文本。', 'error-icon-svg');
                return;
            }

            toggleLoading(textEditWindow, true);

            let prompt = "";
            let apiResponse = "";

            try {
                if (operationType === 'summarize') {
                    prompt = `Summarize the following text:\n\n${currentText}`;
                } else if (operationType === 'continue') {
                    prompt = `Continue the following text, adding a logical continuation based on the provided content. Keep the tone and style consistent. Ensure the continuation is at least two sentences long and provides a natural flow without abruptly ending the thought. If the text is very short, extend it with creative related ideas.:\n\n${currentText}`;
                }

                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    apiResponse = result.candidates[0].content.parts[0].text;
                } else {
                    apiResponse = "抱歉，未能生成内容。请稍后再试。";
                    console.error("Gemini API returned unexpected structure:", result);
                }
            }
            catch (error) {
                apiResponse = `发生错误: ${error.message}`;
                console.error("Error calling Gemini API:", error);
            }
            finally {
                toggleLoading(textEditWindow, false);

                if (operationType === 'summarize') {
                    showMessageBox('总结结果', apiResponse, 'info-icon-svg');
                } else if (operationType === 'continue') {
                    textEditTextArea.value += "\n\n" + apiResponse;
                    isContentSaved = false;
                    updateTextEditStatusBar();
                    showMessageBox('续写成功', '文本已续写。', 'info-icon-svg');
                }
            }
        }

        // Add event listeners for LLM buttons
        if (summarizeBtn) {
            summarizeBtn.addEventListener('click', () => performLLMOperation('summarize'));
        }
        if (continueBtn) {
            continueBtn.addEventListener('click', () => performLLMOperation('continue'));
        }

        // Event listener for TextEdit textarea input to update status bar
        if (textEditTextArea) {
            textEditTextArea.addEventListener('input', updateTextEditStatusBar);

            // Bind file menu items for TextEdit
            document.getElementById('textedit-file-menu').addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                if (action === 'textedit-new-doc') {
                    newTextEditDocument();
                } else if (action === 'textedit-open-doc') {
                    openTextEditDocument();
                } else if (action === 'textedit-save-doc') {
                    saveTextEditDocument(false);
                } else if (action === 'textedit-save-as-doc') {
                    saveTextEditDocument(true);
                }
            });
        }

        // --- Wallpaper Settings Functions ---
        const wallpaperSettingsWindow = document.getElementById('wallpaper-settings-window');
        const presetWallpapersGrid = document.getElementById('preset-wallpapers-grid');
        const uploadWallpaperInput = document.getElementById('upload-wallpaper-input');
        const applyWallpaperBtn = document.getElementById('apply-wallpaper-btn');
        const cancelWallpaperBtn = document.getElementById('cancel-wallpaper-btn');

        const presetWallpapers = [
            { name: '雨林', url: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Jungle_forest_from_above.jpg/1280px-Jungle_forest-from-above.jpg' },
            { name: '蓝色渐变', url: 'https://placehold.co/1280x800/87CEEB/FFFFFF?text=Blue+Gradient' },
            { name: '抽象网格', url: 'https://placehold.co/1280x800/E0E0E0/424242?text=Abstract+Grid' },
            { name: '山脉', url: 'https://placehold.co/1280x800/778899/FFFFFF?text=Mountain' },
            { name: '太空', url: 'https://placehold.co/1280x800/1C1C1C/BBBBBB?text=Space' },
            { name: '经典灰色', url: '' } // Represents the default grey background
        ];

        let selectedWallpaperUrl = desktopBg.style.backgroundImage.replace(/url\(['"]?(.*?)['"]?\)/, '$1') || '';

        function renderPresetWallpapers() {
            presetWallpapersGrid.innerHTML = '';
            presetWallpapers.forEach(wallpaper => {
                const wallpaperItem = document.createElement('div');
                wallpaperItem.classList.add('wallpaper-item', 'cursor-pointer', 'relative', 'border-2', 'border-transparent', 'hover:border-blue-500', 'rounded-sm', 'overflow-hidden');
                wallpaperItem.style.width = '100px';
                wallpaperItem.style.height = '60px';
                wallpaperItem.style.backgroundImage = wallpaper.url ? `url('${wallpaper.url}')` : 'none';
                wallpaperItem.style.backgroundColor = wallpaper.url ? '' : '#C0C0C0';
                wallpaperItem.style.backgroundSize = 'cover';
                wallpaperItem.style.backgroundPosition = 'center';
                wallpaperItem.dataset.url = wallpaper.url;

                const nameOverlay = document.createElement('div');
                nameOverlay.classList.add('absolute', 'bottom-0', 'left-0', 'right-0', 'bg-black', 'bg-opacity-50', 'text-white', 'text-xs', 'text-center', 'py-1');
                nameOverlay.textContent = wallpaper.name;
                wallpaperItem.appendChild(nameOverlay);

                if (selectedWallpaperUrl === wallpaper.url) {
                    wallpaperItem.classList.add('border-blue-500');
                }

                wallpaperItem.addEventListener('click', () => {
                    document.querySelectorAll('.wallpaper-item').forEach(item => item.classList.remove('border-blue-500'));
                    wallpaperItem.classList.add('border-blue-500');
                    selectedWallpaperUrl = wallpaper.url;
                });
                presetWallpapersGrid.appendChild(wallpaperItem);
            });
        }

        applyWallpaperBtn.addEventListener('click', () => {
            if (selectedWallpaperUrl) {
                desktopBg.style.backgroundImage = `url('${selectedWallpaperUrl}')`;
                desktopBg.style.backgroundColor = '';
            } else {
                desktopBg.style.backgroundImage = 'none';
                desktopBg.style.backgroundColor = '#C0C0C0'; /* Always set to Mac OS 9 grey */
            }
            closeWindow(wallpaperSettingsWindow);
            showMessageBox('桌面背景', '桌面背景已更改。', 'wallpaper-icon-svg');
        });

        cancelWallpaperBtn.addEventListener('click', () => {
            closeWindow(wallpaperSettingsWindow);
        });

        uploadWallpaperInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    selectedWallpaperUrl = event.target.result;
                    document.querySelectorAll('.wallpaper-item').forEach(item => item.classList.remove('border-blue-500'));
                    showMessageBox('上传成功', '自定义壁纸已加载。请点击“应用”设置。', 'info-icon-svg');
                };
                reader.readAsDataURL(file);
            }
        });

        // Event listener to render wallpapers when the settings window is opened
        wallpaperSettingsWindow.addEventListener('open', renderPresetWallpapers);

        // Initial load: Ensure all windows are hidden, only desktop icons are visible
        document.addEventListener('DOMContentLoaded', () => {
            // Menubar icons
            insertSvg(document.querySelector('#apple-logo-menu-item .icon-container'), 'apple-logo-icon-svg');
            document.querySelector('#apple-logo-menu-item .icon-container svg').classList.add('preserve-color');

            insertSvg(document.querySelector('.macos-menubar-system-tray .icon-container:nth-of-type(1)'), 'network-icon-svg');
            insertSvg(document.querySelector('.macos-menubar-system-tray .icon-container:nth-of-type(2)'), 'volume-icon-svg');
            insertSvg(document.querySelector('.macos-menubar-system-tray .icon-container:nth-of-type(3)'), 'settings-icon-svg');
            insertSvg(document.querySelector('.macos-menubar-system-tray .icon-container:nth-of-type(4)'), 'desktop-icon-svg');

            // Desktop Icons (initial render)
            // Initial icons are placed directly with their `top` and `left` in HTML
            insertSvg(document.querySelector('#databox-icon .icon-container'), 'databox-icon-svg');
            insertSvg(document.querySelector('#trash-icon .icon-container'), 'trash-icon-svg');

            // Hello Window internal icons
            insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[0], 'blue-folder-icon-svg');
            insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[1], 'blue-folder-icon-svg');
            insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[2], 'document-icon-svg');
            insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[3], 'package-icon-svg');
            insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[4], 'disk-icon-svg');
            insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[5], 'filled-circle-svg');
            insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[6], 'empty-circle-svg');
            insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[7], 'checkmark-svg');
            // Additional icons for Hello Window to ensure scrollability
            for (let i = 8; i < 16; i++) { // Assuming 8 more items are added for scrollability
                insertSvg(document.querySelectorAll('.hello-window-icons-grid .macos-explorer-item .icon-container')[i], 'document-icon-svg');
            }


            // DataBox Window internal icons
            insertSvg(document.querySelectorAll('#databox-window .macos-explorer-item .icon-container')[0], 'macintosh-hd-icon-svg');
            insertSvg(document.querySelectorAll('#databox-window .macos-explorer-item .icon-container')[1], 'cd-rom-icon-svg');
            insertSvg(document.querySelectorAll('#databox-window .macos-explorer-item .icon-container')[2], 'floppy-disk-icon-svg');
            // Additional icons for DataBox Window
            for (let i = 3; i < 7; i++) { // Assuming 4 more items
                insertSvg(document.querySelectorAll('#databox-window .macos-explorer-item .icon-container')[i], 'disk-icon-svg');
            }


            // Trash Window internal icon
            insertSvg(document.querySelector('#trash-window .macos-content-inset .icon-container'), 'trash-icon-svg');

            // Applications Window internal icons
            insertSvg(document.querySelectorAll('#applications-window .macos-explorer-item .icon-container')[0], 'calculator-icon-svg');
            insertSvg(document.querySelectorAll('#applications-window .macos-explorer-item .icon-container')[1], 'paint-icon-svg');
            insertSvg(document.querySelectorAll('#applications-window .macos-explorer-item .icon-container')[2], 'game-controller-icon-svg');
            insertSvg(document.querySelectorAll('#applications-window .macos-explorer-item .icon-container')[3], 'browser-icon-svg');
            insertSvg(document.querySelectorAll('#applications-window .macos-explorer-item .icon-container')[4], 'media-player-icon-svg');
            insertSvg(document.querySelectorAll('#applications-window .macos-explorer-item .icon-container')[5], 'mail-icon-svg');
            // Additional icons for Applications Window
            for (let i = 6; i < 10; i++) { // Assuming 4 more items
                insertSvg(document.querySelectorAll('#applications-window .macos-explorer-item .icon-container')[i], 'applications-icon-svg');
            }


            // Application Menu icons
            insertSvg(document.querySelector('#application-menu .macos-application-menu-user .icon-container'), 'user-avatar-svg');
            insertSvg(document.querySelector('#application-menu .macos-application-menu-item[data-title="关于此 Mac"] .icon-container'), 'apple-logo-icon-svg');
            document.querySelector('#application-menu .macos-application-menu-item[data-title="关于此 Mac"] .icon-container svg').classList.add('preserve-color');

            insertSvg(document.querySelector('#application-menu .macos-application-menu-item.has-submenu > .icon-container'), 'applications-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-sub-menu .macos-application-menu-item[data-target="applications-window"] .icon-container'), 'applications-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-sub-menu .macos-application-menu-item[data-target="hello-window"] .icon-container'), 'hello-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-sub-menu .macos-application-menu-item[data-target="textedit-window"] .icon-container'), 'textedit-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-sub-menu .macos-application-menu-item[data-target="on-off-dialog"] .icon-container'), 'settings-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-application-menu-item[data-title="偏好设置"] .icon-container'), 'settings-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-application-menu-item[data-title="服务"] .icon-container'), 'services-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-application-menu-item[data-title="强制退出"] .icon-container'), 'force-quit-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-application-menu-item[data-title="睡眠"] .icon-container'), 'sleep-icon-svg');
            insertSvg(document.querySelector('#application-menu .macos-application-menu-item[data-title="关机"] .icon-container'), 'shutdown-icon-svg');
            
            // TextEdit File menu icons
            insertSvg(document.querySelector('#textedit-file-menu [data-action="textedit-new-doc"] .icon-container'), 'new-file-icon-svg');
            insertSvg(document.querySelector('#textedit-file-menu [data-action="textedit-open-doc"] .icon-container'), 'open-file-icon-svg');
            insertSvg(document.querySelector('#textedit-file-menu [data-action="textedit-save-doc"] .icon-container'), 'save-file-icon-svg');
            insertSvg(document.querySelector('#textedit-file-menu [data-action="textedit-save-as-doc"] .icon-container'), 'save-file-icon-svg');

            // Finder File menu icons
            insertSvg(document.querySelector('#finder-file-menu-item [data-action="new-folder"] .icon-container'), 'new-folder-icon-svg');
            insertSvg(document.querySelector('#finder-file-menu-item [data-action="get-info"] .icon-container'), 'get-info-icon-svg');
            insertSvg(document.querySelector('#finder-file-menu-item [data-action="empty-trash"] .icon-container'), 'empty-trash-icon-svg');
            insertSvg(document.querySelector('#finder-file-menu-item [data-action="close-active-window"] .icon-container'), 'error-icon-svg');
            insertSvg(document.querySelector('#finder-file-menu-item [data-action="change-wallpaper"] .icon-container'), 'wallpaper-icon-svg');

            // Message Box icons (initial setup)
            // The message box titlebar logo is set dynamically in showMessageBox, so no need to pre-set here.
            insertSvg(document.querySelector('#message-box-icon-container'), 'info-icon-svg');
            
            // Set initial window logos and setup scrollbars
            Object.values(windows).forEach(win => {
                if (win.element) {
                    const logoArea = win.element.querySelector('.macos-window-titlebar .window-logo-area .icon-container');
                    if (logoArea && win.icon) {
                        insertSvg(logoArea, win.icon);
                    }
                    // Setup custom scrollbar for each window
                    const contentInset = win.element.querySelector('.macos-content-inset');
                    const verticalScrollbar = win.element.querySelector('.macos-vertical-scrollbar');
                    if (contentInset && verticalScrollbar) {
                        setupCustomScrollbar(contentInset, verticalScrollbar);
                    }
                }
            });


            // Ensure all windows are initially hidden
            Object.values(windows).forEach(win => {
                if (win.element) win.element.style.display = 'none';
            });

            // Activate Finder (default active app)
            activeAppTitleDisplay.textContent = 'Finder';

            // Update menubar time
            updateTime();
            setInterval(updateTime, 1000);

            // Initial status bar update for TextEdit
            if (textEditTextArea) {
                updateTextEditStatusBar();
            }

            // Render preset wallpapers when the page loads
            renderPresetWallpapers();
        });

        // Time Display Function
        function updateTime() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? ' PM' : ' AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            document.getElementById('current-time').textContent = `${hours}:${minutes}${ampm}`;
        }
    </script>
</body>
</html>
